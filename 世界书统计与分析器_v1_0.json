{
  "id": "88c73192-4663-450a-9e95-be5302d8913a",
  "name": "世界书统计与分析器 v1.0",
  "content": "(async () => {\n    \"use strict\";\n\n    // --- Configuration ---\n    const DEBUG_MODE = true;\n    const BUTTON_ID = 'th-token-checker-button-v2h';\n    const POPUP_CONTENT_ID = 'th-token-checker-content-v2h';\n    const MAX_AI_HISTORY = 6; // AI分析最多保留的对话轮数 (用户问 + AI答 = 2条)\n\n    // 添加全局变量\n    let currentViewingLorebook = null; // 全局变量跟踪当前查看的世界书\n    let stats = null; // 全局存储统计数据\n    let aiAnalysisHistory = []; // [新增] 用于AI个性化分析的对话历史\n\n    // --- Style Colors (Updated for Vectorized & New Charts) ---\n    const COLOR_CHARACTER = '#36A2EB';     // Blue for Character\n    const COLOR_CONSTANT = '#4BC0C0';        // Cyan for Constant\n    const COLOR_SELECTIVE = '#90EE90';       // Green for Selective\n    const COLOR_VECTORIZED = '#FFCE56';      // Yellow for Vectorized\n    const COLOR_LOREBOOK_TOTAL = '#FF4500';  // Red for Total Lorebook in combined bar\n    const COLOR_BACKGROUND = 'rgba(255, 255, 255, 0.1)';\n    const STYLE_CONSTANT_TEXT = 'color: #4BC0C0; font-weight: bold;';\n    const STYLE_SELECTIVE_TEXT = 'color: #90EE90; font-weight: bold;';\n    const STYLE_VECTORIZED_TEXT = 'color: #FFCE56; font-weight: bold;';\n    const STYLE_CHARACTER_TEXT = 'color: #36A2EB; font-weight: bold;';\n    const STYLE_SOURCE_PRIMARY = 'color: #FF4500;';\n    const STYLE_SOURCE_ADDITIONAL = 'color: #9966FF;';\n    const STYLE_SOURCE_GLOBAL = 'color: #C9CBCF;';\n    const STYLE_SOURCE_CHAT = 'color: #FF9F40;';\n\n    // --- API & Context Checks ---\n    logDebug(\"脚本开始加载 (HTML 版 v2.5.5 - 美化界面)，检查环境...\"); // Version updated\n    if (typeof SillyTavern !== 'object' || !SillyTavern.characters || !SillyTavern.groups || typeof SillyTavern.getTokenCount !== 'function') { console.error('[TokenCheckerV2H] ST Context无效'); return; }\n    if (typeof SillyTavern.callGenericPopup !== 'function' || typeof SillyTavern.POPUP_TYPE === 'undefined') { console.error('[TokenCheckerV2H] ST Popup功能(callGenericPopup)在上下文中未找到！'); return; }\n    // [修改] 检查 generateRaw 是否存在\n    if (typeof TavernHelper === 'undefined' || typeof TavernHelper.getCharLorebooks === 'undefined' || typeof TavernHelper.getLorebookEntries === 'undefined' || typeof TavernHelper.getLorebookSettings === 'undefined' || typeof TavernHelper.getOrCreateChatLorebook === 'undefined' || typeof TavernHelper.generateRaw === 'undefined' || typeof TavernHelper.generate === 'undefined') { console.error('[TokenCheckerV2H] TavernHelper API缺失 (需要 getCharLorebooks, getLorebookEntries, getLorebookSettings, getOrCreateChatLorebook, generate, generateRaw)'); return; }\n    logDebug(\"SillyTavern Context, Popup, TavernHelper API 有效.\");\n\n    const parentWindow = window.parent;\n    const parent$ = parentWindow.$; // 获取父窗口的jQuery引用\n    const parentToastr = parentWindow.toastr;\n    const callGenericPopup = SillyTavern.callGenericPopup;\n    const POPUP_TYPE = SillyTavern.POPUP_TYPE;\n    if (typeof parent$ !== 'function') { console.error('[TokenCheckerV2H] Parent jQuery ($) not found.'); return; } // 确保jQuery可用\n    if (typeof parentToastr !== 'object') { console.warn('[TokenCheckerV2H] Parent toastr not found.'); } else { logDebug(\"Parent toastr 有效.\"); }\n\n\n    // --- Helper Functions ---\n    function logDebug(...args) {\n        if (DEBUG_MODE) console.log('[TokenCheckerV2H]', ...args);\n    }\n\n    const escapeHtml = (unsafe) => {\n        if (!unsafe) return '';\n        return String(unsafe)\n            .replace(/&/g, \"&amp;\")\n            .replace(/</g, \"&lt;\")\n            .replace(/>/g, \"&gt;\")\n            .replace(/\"/g, \"&quot;\")\n            .replace(/'/g, \"&#39;\");\n    };\n    function getTokenCount(text) { if (!text || typeof text !== 'string') return 0; try { return SillyTavern.getTokenCount(text); } catch (error) { console.error('[TokenCheckerV2H] getTokenCount error:', error); return 0; } }\n\n    // [新增] 辅助函数：格式化条目插入位置\n    function formatPosition(position, depth) {\n        const posMap = {\n            'before_character_definition': '角色定义前',\n            'after_character_definition': '角色定义后',\n            'before_example_messages': '示例消息前',\n            'after_example_messages': '示例消息后',\n            'before_author_note': '作者注释前',\n            'after_author_note': '作者注释后',\n            'at_depth_as_system': `系统 (@D${depth ?? '?'})`,\n            'at_depth_as_assistant': `助手 (@D${depth ?? '?'})`,\n            'at_depth_as_user': `用户 (@D${depth ?? '?'})`\n        };\n        return posMap[position] || position || '未知';\n    }\n\n\n    // 辅助函数：获取或计算Token，处理null/undefined内容\n    function getEntryTokens(entry) {\n    // 如果 entry.tk 存在且是数字，直接返回\n    if (entry && typeof entry.tk === 'number') {\n        return entry.tk;\n    }\n    // 否则，使用 getTokenCount 计算 content 的 token\n    // 如果 entry 或 entry.content 不存在，则视为空字符串\n    return getTokenCount(entry?.content ?? '');\n    }\n\n    // [新增] 辅助函数：格式化扫描深度\n    function formatScanDepth(scanDepth) {\n        if (scanDepth === 'same_as_global') {\n            return '全局';\n        } else if (typeof scanDepth === 'number') {\n            return scanDepth.toString();\n        }\n        return '未知';\n    }\n\n    // --- Core Data Calculation (Unchanged from v2.5.4) ---\n    async function calculateTokenStats() {\n        logDebug(\"calculateTokenStats: 开始计算 Token 统计数据...\");\n        const startTime = Date.now();\n        const context = SillyTavern;\n        const stats = {\n            characterCardTokens: 0, characterName: '未知',\n            totalConstantTokens: 0, totalSelectiveTokens: 0, totalVectorizedTokens: 0,\n            totalTokens: 0,\n            bySource: {\n                primary: { c: 0, s: 0, v: 0, books: [] }, additional: { c: 0, s: 0, v: 0, books: [] },\n                global: { c: 0, s: 0, v: 0, books: [] }, chat: { c: 0, s: 0, v: 0, books: [] },\n            },\n            byLorebook: {}, allEntries: [], // allEntries 只包含启用的\n            calculationTime: 0, error: null,\n        };\n        try {\n            // 1. Character Card Tokens\n            if (context.characterId !== undefined && context.characters[context.characterId]) {\n                const character = context.characters[context.characterId]; stats.characterName = character.name; const fields = [character.description, character.personality, character.scenario, character.first_mes]; stats.characterCardTokens = getTokenCount(fields.filter(Boolean).join('\\n'));\n            } else if (context.groupId) { const group = context.groups.find(g => g.id === context.groupId); if (group) { stats.characterName = group.name || `Group ${context.groupId}`; stats.characterCardTokens = 0; for (const memberAvatar of group.members) { const memberData = context.characters.find(c => c.avatar === memberAvatar); if (memberData) { const fields = [memberData.description, memberData.personality, memberData.scenario, memberData.first_mes]; stats.characterCardTokens += getTokenCount(fields.filter(Boolean).join('\\n')); } } } }\n            else { stats.characterName = '(无角色/群组)'; }\n\n            // 2. Gather Lorebooks\n            const lorebooksToProcess = new Map(); const settings = await TavernHelper.getLorebookSettings(); let charLorebooks = { primary: null, additional: [] }; if (context.characterId !== undefined) { try { charLorebooks = await TavernHelper.getCharLorebooks(); } catch (e) { logDebug(\"获取角色世界书出错:\", e); } } if (charLorebooks.primary) lorebooksToProcess.set(charLorebooks.primary, 'primary'); charLorebooks.additional.forEach(book => { if (!lorebooksToProcess.has(book)) lorebooksToProcess.set(book, 'additional'); }); settings.selected_global_lorebooks.forEach(book => { if (!lorebooksToProcess.has(book)) lorebooksToProcess.set(book, 'global'); }); try { const chatBook = await TavernHelper.getOrCreateChatLorebook(); if (chatBook && !lorebooksToProcess.has(chatBook)) { lorebooksToProcess.set(chatBook, 'chat'); } } catch (e) { logDebug(\"获取聊天世界书出错:\", e); }\n\n            // 3. Process Entries (只处理启用的条目用于概览统计)\n            for (const [bookName, source] of lorebooksToProcess.entries()) {\n                stats.byLorebook[bookName] = { c: 0, s: 0, v: 0, t: 0, src: source, entries: [] }; // entries 存储启用的详情\n                try {\n                    const entries = await TavernHelper.getLorebookEntries(bookName); // 获取所有条目，但只统计启用的\n                    let processedCount = 0;\n                    for (const entry of entries) {\n                        if (!entry.enabled) continue; // 跳过禁用的条目进行统计\n\n                        const entryTokens = getTokenCount(entry.content);\n                        //if (entryTokens === 0 && !(entry.comment && entry.comment.trim())) continue; // 允许0 token条目存在于统计中，但可能不计入token总数\n\n                        let entryType;\n                        if (entry.type === 'constant') entryType = 'c';\n                        else if (entry.type === 'selective') entryType = 's';\n                        else if (entry.type === 'vectorized') entryType = 'v';\n                        else { logDebug(`未知条目类型 '${entry.type}' for UID ${entry.uid} in book '${bookName}'. Treating as selective.`); entryType = 's'; }\n\n                        if (entryType === 'c') { stats.totalConstantTokens += entryTokens; stats.bySource[source].c += entryTokens; stats.byLorebook[bookName].c += entryTokens; }\n                        else if (entryType === 's') { stats.totalSelectiveTokens += entryTokens; stats.bySource[source].s += entryTokens; stats.byLorebook[bookName].s += entryTokens; }\n                        else if (entryType === 'v') { stats.totalVectorizedTokens += entryTokens; stats.bySource[source].v += entryTokens; stats.byLorebook[bookName].v += entryTokens; }\n                        stats.byLorebook[bookName].t += entryTokens;\n\n                        // 将启用的条目详情存入 stats.byLorebook[bookName].entries (用于可能的快速预览，但详情页会重新获取)\n                        const entryDetail = { name: entry.comment || `(UID: ${entry.uid})`, type: entryType, tk: entryTokens };\n                        stats.byLorebook[bookName].entries.push(entryDetail);\n                        // 将启用的条目详情存入 stats.allEntries (用于AI分析)\n                        stats.allEntries.push({ book: bookName, name: entryDetail.name, type: entryType, tk: entryTokens });\n                        processedCount++;\n                    }\n                    if (processedCount > 0 || stats.byLorebook[bookName].t > 0) {\n                         logDebug(`calculateTokenStats:  - '${bookName}' 处理了 ${processedCount} 个有效条目。总 T: ${stats.byLorebook[bookName].t} (C: ${stats.byLorebook[bookName].c}, S: ${stats.byLorebook[bookName].s}, V: ${stats.byLorebook[bookName].v})`);\n                         if (!stats.bySource[source].books.includes(bookName)) { stats.bySource[source].books.push(bookName); }\n                    } else {\n                         // 如果一个书没有任何启用的条目且总token为0，可以考虑从概览中移除\n                         // delete stats.byLorebook[bookName];\n                         // const bookIndex = stats.bySource[source].books.indexOf(bookName);\n                         // if (bookIndex > -1) { stats.bySource[source].books.splice(bookIndex, 1); }\n                         logDebug(`calculateTokenStats: - '${bookName}' 无启用的有效条目，但保留在列表中。`);\n                         if (!stats.bySource[source].books.includes(bookName)) { stats.bySource[source].books.push(bookName); } // 仍然记录书名\n                    }\n                } catch (e) { console.error(`处理世界书 '${bookName}' 时出错:`, e); delete stats.byLorebook[bookName]; }\n            }\n\n            // 4. Final Calc\n            stats.totalTokens = stats.characterCardTokens + stats.totalConstantTokens + stats.totalSelectiveTokens + stats.totalVectorizedTokens;\n            logDebug(`calculateTokenStats: 最终计算: 总 Tokens = ${stats.characterCardTokens} (角色) + ${stats.totalConstantTokens} (蓝灯) + ${stats.totalSelectiveTokens} (绿灯) + ${stats.totalVectorizedTokens} (向量) = ${stats.totalTokens}`);\n        } catch (error) { console.error('[TokenCheckerV2H] calculateTokenStats error:', error); stats.error = error.message || '未知计算错误'; }\n        finally {\n            stats.calculationTime = Date.now() - startTime;\n            logDebug(`Token 统计计算完成，耗时: ${stats.calculationTime}ms`, stats);\n        }\n\n        // 更新全局变量stats\n        return stats;\n    }\n\n    // --- HTML Rendering Functions (Rewritten with new modern styling) ---\n    function createBeautifiedHtml(stats) {\n        logDebug(\"createBeautifiedHtml: 开始生成美化版HTML...\");\n\n        // 创建基础HTML结构\n        const htmlContent = `\n        <style>\n            :root {\n                --bg-dark: #1a1a1a;\n                --bg-darker: #111;\n                --bg-light: #222;\n                --border-color: #333;\n                --border-color-subtle: #2a2a2a;\n                --text-primary: #f0f0f0;\n                --text-secondary: #aaa;\n\n                /* 增强对比度的颜色 */\n                --highlight-blue: #00AEEF;\n                --highlight-orange: #FFA500;\n                --chart-blue: #36A2EB;\n                --chart-teal: #4BC0C0;\n                --chart-green: #90EE90;\n                --chart-yellow: #FFCE56;\n                --chart-red: #FF4500;\n                --chart-purple: #9966FF;\n                --chart-gray: #C9CBCF;\n\n                /* 添加卡片主题色 */\n                --card-total: #FF4500;\n                --card-character: #36A2EB;\n                --card-lorebook: #FFCE56;\n            }\n\n            #${POPUP_CONTENT_ID} {\n                background-color: var(--bg-darker);\n                color: var(--text-primary);\n                font-family: 'Segoe UI', system-ui, sans-serif;\n                line-height: 1.6;\n            }\n\n            #${POPUP_CONTENT_ID} .container {\n                max-width: 100%;\n                margin: 0 auto;\n                padding: 10px;\n            }\n\n            #${POPUP_CONTENT_ID} .header {\n                text-align: center;\n                margin-bottom: 20px;\n                padding-bottom: 15px;\n                border-bottom: 1px solid var(--border-color);\n            }\n\n            #${POPUP_CONTENT_ID} .header h1 {\n                font-size: 2rem;\n                margin: 0;\n                color: var(--highlight-blue);\n                font-weight: 700;\n            }\n\n            #${POPUP_CONTENT_ID} .header p {\n                color: var(--text-secondary);\n                margin-top: 10px;\n                font-size: 0.95rem;\n            }\n\n            #${POPUP_CONTENT_ID} .grid {\n                display: grid;\n                grid-template-columns: repeat(12, 1fr);\n                gap: 15px;\n                margin-bottom: 20px;\n            }\n\n            #${POPUP_CONTENT_ID} .card {\n                background-color: var(--bg-light);\n                border-radius: 8px;\n                padding: 15px;\n                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n                border: 1px solid var(--border-color);\n                transition: transform 0.3s ease, box-shadow 0.3s ease;\n                animation: fadeInUp 0.5s ease-out forwards;\n                opacity: 0;\n            }\n\n            @keyframes fadeInUp {\n                from {\n                    opacity: 0;\n                    transform: translateY(20px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateY(0);\n                }\n            }\n\n            /* 为不同卡片添加延迟，创造级联效果 */\n            #${POPUP_CONTENT_ID} .card:nth-child(1) { animation-delay: 0.1s; }\n            #${POPUP_CONTENT_ID} .card:nth-child(2) { animation-delay: 0.2s; }\n            #${POPUP_CONTENT_ID} .card:nth-child(3) { animation-delay: 0.3s; }\n            #${POPUP_CONTENT_ID} .card:nth-child(4) { animation-delay: 0.4s; }\n            #${POPUP_CONTENT_ID} .card:nth-child(5) { animation-delay: 0.5s; }\n            #${POPUP_CONTENT_ID} .card:nth-child(6) { animation-delay: 0.6s; }\n            #${POPUP_CONTENT_ID} .card:nth-child(7) { animation-delay: 0.7s; }\n\n            #${POPUP_CONTENT_ID} .card:hover {\n                transform: translateY(-3px);\n                box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);\n            }\n\n            #${POPUP_CONTENT_ID} .card-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                margin-bottom: 12px;\n                padding-bottom: 8px;\n                border-bottom: 1px solid var(--border-color);\n            }\n\n            #${POPUP_CONTENT_ID} .card-title {\n                font-size: 1.2rem;\n                font-weight: 600;\n                margin: 0;\n                color: var(--highlight-blue);\n            }\n\n            #${POPUP_CONTENT_ID} .card-icon {\n                font-size: 1.3rem;\n                color: var(--highlight-orange);\n            }\n\n            #${POPUP_CONTENT_ID} .stat-card {\n                grid-column: span 4;\n            }\n\n            #${POPUP_CONTENT_ID} .chart-card {\n                grid-column: span 6;\n            }\n\n            #${POPUP_CONTENT_ID} .wide-card {\n                grid-column: span 12;\n            }\n\n            #${POPUP_CONTENT_ID} .stat-value {\n                font-size: 2.2rem;\n                font-weight: 700;\n                margin: 8px 0;\n                color: var(--highlight-orange);\n                counter-reset: stat-counter 0;\n                animation: countUp 1.2s cubic-bezier(0.215, 0.610, 0.355, 1.000) forwards;\n            }\n\n            @keyframes countUp {\n                from {\n                    opacity: 0;\n                    transform: translateY(10px);\n                    filter: blur(5px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateY(0);\n                    filter: blur(0);\n                }\n            }\n\n            #${POPUP_CONTENT_ID} .stat-label {\n                color: var(--text-secondary);\n                font-size: 0.85rem;\n            }\n\n            #${POPUP_CONTENT_ID} .token-breakdown {\n                display: flex;\n                justify-content: space-between;\n                margin-top: 12px;\n            }\n\n            #${POPUP_CONTENT_ID} .token-type {\n                text-align: center;\n                padding: 8px;\n                border-radius: 6px;\n                flex: 1;\n                margin: 0 4px;\n                animation: fadeInUp 0.5s ease-out forwards;\n                opacity: 0;\n            }\n\n            #${POPUP_CONTENT_ID} .token-type.constant {\n                background-color: rgba(75, 192, 192, 0.1);\n                border: 1px solid var(--chart-teal);\n                animation-delay: 0.1s;\n            }\n\n            #${POPUP_CONTENT_ID} .token-type.selective {\n                background-color: rgba(144, 238, 144, 0.1);\n                border: 1px solid var(--chart-green);\n                animation-delay: 0.2s;\n            }\n\n            #${POPUP_CONTENT_ID} .token-type.vectorized {\n                background-color: rgba(255, 206, 86, 0.1);\n                border: 1px solid var(--chart-yellow);\n                animation-delay: 0.3s;\n            }\n\n            #${POPUP_CONTENT_ID} .token-type-value {\n                font-size: 1.3rem;\n                font-weight: 600;\n                margin: 4px 0;\n            }\n\n            #${POPUP_CONTENT_ID} .token-type-label {\n                font-size: 0.8rem;\n                color: var(--text-secondary);\n            }\n\n            #${POPUP_CONTENT_ID} .source-list {\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n            }\n\n            #${POPUP_CONTENT_ID} .source-item {\n                background-color: var(--bg-dark);\n                border-radius: 6px;\n                padding: 12px;\n                border-left: 4px solid;\n            }\n\n            #${POPUP_CONTENT_ID} .source-item.primary {\n                border-left-color: var(--chart-red);\n            }\n\n            #${POPUP_CONTENT_ID} .source-item.additional {\n                border-left-color: var(--chart-purple);\n            }\n\n            #${POPUP_CONTENT_ID} .source-item.global {\n                border-left-color: var(--chart-gray);\n            }\n\n            #${POPUP_CONTENT_ID} .source-item.chat {\n                border-left-color: var(--highlight-orange);\n            }\n\n            #${POPUP_CONTENT_ID} .source-header {\n                display: flex;\n                justify-content: space-between;\n                margin-bottom: 8px;\n            }\n\n            #${POPUP_CONTENT_ID} .source-name {\n                font-weight: 600;\n                font-size: 1.05rem;\n            }\n\n            #${POPUP_CONTENT_ID} .source-total {\n                font-weight: 700;\n                color: var(--highlight-orange);\n            }\n\n            #${POPUP_CONTENT_ID} .source-books {\n                font-size: 0.85rem;\n                color: var(--text-secondary);\n                margin-bottom: 8px;\n                display: block;\n            }\n\n            #${POPUP_CONTENT_ID} .source-breakdown {\n                display: flex;\n                gap: 8px;\n                margin-top: 8px;\n            }\n\n            #${POPUP_CONTENT_ID} .source-breakdown-item {\n                flex: 1;\n                text-align: center;\n                padding: 6px;\n                border-radius: 4px;\n                font-size: 0.85rem;\n            }\n\n            #${POPUP_CONTENT_ID} .lorebook-table {\n                width: 100%;\n                border-collapse: collapse;\n                margin-top: 12px;\n            }\n\n            #${POPUP_CONTENT_ID} .lorebook-table th,\n            #${POPUP_CONTENT_ID} .lorebook-table td {\n                padding: 10px 12px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n            }\n\n            #${POPUP_CONTENT_ID} .lorebook-table th {\n                background-color: var(--bg-dark);\n                font-weight: 600;\n                color: var(--highlight-blue);\n            }\n\n            #${POPUP_CONTENT_ID} .lorebook-table tr:hover {\n                background-color: rgba(255, 255, 255, 0.03);\n            }\n\n            #${POPUP_CONTENT_ID} .lorebook-table tbody tr:last-child td {\n                border-bottom: none;\n            }\n\n            #${POPUP_CONTENT_ID} .btn {\n                padding: 6px 12px;\n                border-radius: 4px;\n                border: none;\n                font-weight: 600;\n                cursor: pointer;\n                transition: all 0.2s ease;\n            }\n\n            #${POPUP_CONTENT_ID} .btn-primary {\n                background-color: var(--highlight-blue);\n                color: white;\n            }\n\n            #${POPUP_CONTENT_ID} .btn-primary:hover {\n                background-color: #0095d9;\n            }\n\n            #${POPUP_CONTENT_ID} .btn-outline {\n                background-color: transparent;\n                border: 1px solid var(--highlight-blue);\n                color: var(--highlight-blue);\n            }\n\n            #${POPUP_CONTENT_ID} .btn-outline:hover {\n                background-color: rgba(0, 174, 239, 0.1);\n            }\n\n            #${POPUP_CONTENT_ID} .text-highlight {\n                color: var(--highlight-orange);\n            }\n\n            #${POPUP_CONTENT_ID} .text-muted {\n                color: var(--text-secondary);\n            }\n\n            #${POPUP_CONTENT_ID} #entry-details-section .card-header {\n                margin-bottom: 8px;\n            }\n\n            #${POPUP_CONTENT_ID} #back-to-lorebook-list {\n                padding: 4px 10px;\n                font-size: 0.9rem;\n            }\n\n            #${POPUP_CONTENT_ID} .entry-list-table {\n                width: 100%;\n                border-collapse: collapse;\n                font-size: 0.9em; /* 调整字体大小以适应更多列 */\n            }\n\n            #${POPUP_CONTENT_ID} .entry-list-table th,\n            #${POPUP_CONTENT_ID} .entry-list-table td {\n                padding: 8px 6px; /* 减少内边距 */\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                white-space: nowrap; /* 防止换行 */\n            }\n             #${POPUP_CONTENT_ID} .entry-list-table th:first-child, /* 条目名称列可以宽一点 */\n             #${POPUP_CONTENT_ID} .entry-list-table td:first-child {\n                 white-space: normal; /* 允许条目名称换行 */\n                 min-width: 150px; /* 给条目名称一个最小宽度 */\n             }\n\n\n            #${POPUP_CONTENT_ID} .entry-list-table th {\n                background-color: var(--bg-dark);\n                font-weight: 600;\n                color: var(--highlight-blue);\n            }\n\n            #${POPUP_CONTENT_ID} .entry-list-table tr:hover {\n                background-color: rgba(255, 255, 255, 0.03);\n            }\n\n            #${POPUP_CONTENT_ID} .entry-list-container {\n                max-height: 400px;\n                overflow-y: auto;\n                border-radius: 6px;\n                border: 1px solid var(--border-color);\n            }\n\n            #${POPUP_CONTENT_ID} .entry-comment {\n                /* max-width: 350px; */ /* 移除最大宽度限制，让表格自适应 */\n                overflow: hidden;\n                text-overflow: ellipsis;\n                /* white-space: nowrap; */ /* 已在td:first-child中设为normal */\n                cursor: help;\n            }\n\n            #${POPUP_CONTENT_ID} #ai-query-input {\n                width: 100%;\n                box-sizing: border-box;\n                margin-bottom: 8px;\n                background-color: var(--bg-dark);\n                color: var(--text-primary);\n                border: 1px solid var(--border-color);\n                border-radius: 4px;\n                padding: 8px;\n                resize: vertical;\n                min-height: 40px;\n                transition: all 0.3s ease;\n            }\n\n            #${POPUP_CONTENT_ID} #ai-query-input:focus {\n                border-color: var(--highlight-blue);\n                box-shadow: 0 0 0 3px rgba(0, 174, 239, 0.2);\n                transform: translateY(-1px);\n            }\n\n            #${POPUP_CONTENT_ID} #ai-ask-button {\n                padding: 6px 12px;\n                border-radius: 4px;\n                background: linear-gradient(135deg, var(--highlight-blue) 0%, #0095d9 100%);\n                border: none;\n                color: white;\n                font-weight: 600;\n                cursor: pointer;\n                transition: all 0.3s ease;\n                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);\n            }\n\n            #${POPUP_CONTENT_ID} #ai-ask-button:hover {\n                transform: translateY(-2px);\n                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);\n            }\n\n            #${POPUP_CONTENT_ID} #ai-output-area {\n                margin-top: 10px;\n                background-color: var(--bg-dark);\n                padding: 12px;\n                border-radius: 4px;\n                font-size: 0.9em;\n                white-space: pre-wrap;\n                max-height: 200px;\n                overflow-y: auto;\n                border: 1px solid var(--border-color);\n                line-height: 1.4;\n                transition: all 0.5s ease;\n                max-height: 0;\n                padding: 0;\n                overflow: hidden;\n            }\n\n            #${POPUP_CONTENT_ID} #ai-output-area.show {\n                max-height: 200px;\n                padding: 12px;\n            }\n\n            #${POPUP_CONTENT_ID} .ai-output {\n                margin-top: 10px;\n                background-color: var(--bg-dark);\n                padding: 12px;\n                border-radius: 4px;\n                font-size: 0.9em;\n                white-space: pre-wrap;\n                max-height: 200px;\n                overflow-y: auto;\n                border: 1px solid var(--border-color);\n                line-height: 1.4;\n            }\n\n            /* 为条形图添加动画 */\n            #${POPUP_CONTENT_ID} .source-bar {\n                transition: height 1s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n\n            /* 为饼图添加动画 */\n            #${POPUP_CONTENT_ID} .token-pie-chart {\n                animation: rotateIn 1.5s ease-out forwards, floatRotate 6s ease-in-out infinite;\n            }\n\n            @keyframes rotateIn {\n                from {\n                    transform: rotate(-90deg) scale(0.8);\n                    opacity: 0;\n                }\n                to {\n                    transform: rotate(0) scale(1);\n                    opacity: 1;\n                }\n            }\n\n            @keyframes floatRotate {\n                0% { transform: translateY(0) rotate(0); }\n                50% { transform: translateY(-5px) rotate(2deg); }\n                100% { transform: translateY(0) rotate(0); }\n            }\n\n            @keyframes growUp {\n                from { height: 0; opacity: 0; }\n                to { height: 100%; opacity: 1; }\n            }\n\n            #${POPUP_CONTENT_ID} .source-bar {\n                animation: growUp 1s forwards cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n\n            /* 添加波纹点击效果 */\n            @keyframes ripple {\n                0% { box-shadow: 0 0 0 0 rgba(0, 174, 239, 0.3); }\n                100% { box-shadow: 0 0 0 20px rgba(0, 174, 239, 0); }\n            }\n\n            #${POPUP_CONTENT_ID} .btn:active {\n                animation: ripple 0.6s linear;\n            }\n\n            @media (max-width: 900px) {\n                #${POPUP_CONTENT_ID} .stat-card {\n                    grid-column: span 6;\n                }\n\n                #${POPUP_CONTENT_ID} .chart-card {\n                    grid-column: span 12;\n                }\n\n                #${POPUP_CONTENT_ID} .token-breakdown {\n                    flex-wrap: wrap;\n                }\n\n                #${POPUP_CONTENT_ID} .token-type {\n                    min-width: 100px;\n                    margin-bottom: 6px;\n                }\n            }\n\n            /* 为三个主要卡片设置不同的主题色 */\n            #${POPUP_CONTENT_ID} .stat-card:nth-child(1) .stat-value {\n                color: #FF4500; /* 红色调 - 总Tokens */\n            }\n            #${POPUP_CONTENT_ID} .stat-card:nth-child(2) .stat-value {\n                color: #9966FF; /* 紫色调 - 角色卡 */\n            }\n            #${POPUP_CONTENT_ID} .stat-card:nth-child(3) .stat-value {\n                color: #FFCE56; /* 黄色调 - 世界书 */\n            }\n\n            /* 添加卡片悬停效果 */\n            #${POPUP_CONTENT_ID} .stat-card:nth-child(1):hover {\n                box-shadow: 0 8px 15px rgba(255, 99, 132, 0.2);\n                border-color: rgba(255, 99, 132, 0.4);\n            }\n            #${POPUP_CONTENT_ID} .stat-card:nth-child(2):hover {\n                box-shadow: 0 8px 15px rgba(54, 162, 235, 0.2);\n                border-color: rgba(54, 162, 235, 0.4);\n            }\n            #${POPUP_CONTENT_ID} .stat-card:nth-child(3):hover {\n                box-shadow: 0 8px 15px rgba(255, 206, 86, 0.2);\n                border-color: rgba(255, 206, 86, 0.4);\n            }\n\n            /* AI编辑界面样式增强 */\n            .ai-edit-container {\n                animation: fadeIn 0.5s ease-out;\n            }\n\n            .edit-input-area, .edit-preview-area {\n                background-color: var(--bg-light);\n                border-radius: 10px;\n                padding: 20px;\n                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);\n                transition: all 0.3s ease;\n            }\n\n            .edit-input-area:hover, .edit-preview-area:hover {\n                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);\n            }\n\n            #ai-edit-input {\n                background-color: var(--bg-dark);\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                padding: 12px;\n                transition: all 0.3s ease;\n                resize: vertical;\n            }\n\n            #ai-edit-input:focus {\n                border-color: var(--highlight-blue);\n                box-shadow: 0 0 0 2px rgba(0, 174, 239, 0.2);\n            }\n\n            #generate-edits-button, #apply-edits-button {\n                background: linear-gradient(135deg, #00AEEF 0%, #0095d9 100%);\n                border: none;\n                border-radius: 6px;\n                padding: 10px 20px;\n                font-weight: 600;\n                transition: all 0.3s ease;\n                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);\n            }\n\n            #generate-edits-button:hover, #apply-edits-button:hover {\n                transform: translateY(-2px);\n                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);\n            }\n\n            #ai-edit-preview {\n                background: linear-gradient(to bottom, var(--bg-dark), rgba(26, 26, 26, 0.8));\n                border-radius: 8px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n            }\n\n            .entry-item {\n                transition: all 0.3s ease;\n                border-radius: 6px;\n                padding: 10px !important;\n            }\n\n            .entry-item:hover {\n                background-color: rgba(255, 255, 255, 0.05);\n                transform: translateX(3px);\n            }\n\n            .edit-preview-item {\n                border-left: 3px solid var(--highlight-blue);\n                padding-left: 10px;\n                animation: slideInRight 0.5s ease-out;\n            }\n\n            @keyframes slideInRight {\n                from { opacity: 0; transform: translateX(20px); }\n                to { opacity: 1; transform: translateX(0); }\n            }\n\n            /* 表格交互效果增强 */\n            #${POPUP_CONTENT_ID} .lorebook-table tr {\n                transition: all 0.3s ease;\n            }\n\n            #${POPUP_CONTENT_ID} .lorebook-table tr:hover {\n                background-color: rgba(0, 174, 239, 0.05);\n                transform: translateX(5px);\n            }\n\n            #${POPUP_CONTENT_ID} .view-entries-button {\n                position: relative;\n                overflow: hidden;\n                transition: all 0.3s ease;\n            }\n\n            #${POPUP_CONTENT_ID} .view-entries-button:after {\n                content: \"\";\n                background: rgba(255, 255, 255, 0.2);\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                width: 5px;\n                height: 5px;\n                border-radius: 50%;\n                transform: translate(-50%, -50%) scale(0);\n                opacity: 0;\n                transition: all 0.5s ease;\n            }\n\n            #${POPUP_CONTENT_ID} .view-entries-button:hover:after {\n                transform: translate(-50%, -50%) scale(20);\n                opacity: 1;\n            }\n\n            /* 添加表格行出现动画 */\n            #${POPUP_CONTENT_ID} .lorebook-table tr,\n            #${POPUP_CONTENT_ID} .entry-list-table tr {\n                animation: fadeInUp 0.3s ease-out forwards;\n                opacity: 0;\n            }\n\n            #${POPUP_CONTENT_ID} .lorebook-table tr:nth-child(1) { animation-delay: 0.05s; }\n            #${POPUP_CONTENT_ID} .lorebook-table tr:nth-child(2) { animation-delay: 0.1s; }\n            #${POPUP_CONTENT_ID} .lorebook-table tr:nth-child(3) { animation-delay: 0.15s; }\n            #${POPUP_CONTENT_ID} .lorebook-table tr:nth-child(4) { animation-delay: 0.2s; }\n            #${POPUP_CONTENT_ID} .lorebook-table tr:nth-child(5) { animation-delay: 0.25s; }\n            #${POPUP_CONTENT_ID} .lorebook-table tr:nth-child(n+6) { animation-delay: 0.3s; }\n\n            /* 数据可视化组件增强 */\n            #${POPUP_CONTENT_ID} .source-bar-group {\n                transition: all 0.3s ease;\n            }\n\n            #${POPUP_CONTENT_ID} .source-bar-group:hover {\n                transform: scale(1.05);\n            }\n\n            #${POPUP_CONTENT_ID} .source-bar-group:hover .source-bar-label {\n                font-weight: bold;\n                transform: translateY(-3px);\n            }\n\n            #${POPUP_CONTENT_ID} .source-bar-label,\n            #${POPUP_CONTENT_ID} .source-bar-value {\n                transition: all 0.3s ease;\n            }\n\n            #${POPUP_CONTENT_ID} .source-bar-group:hover .source-bar-value {\n                font-size: 0.9rem;\n                font-weight: bold;\n            }\n\n            /* 来源项目交互效果 */\n            #${POPUP_CONTENT_ID} .source-item {\n                transition: all 0.3s ease;\n            }\n\n            #${POPUP_CONTENT_ID} .source-item:hover {\n                transform: translateY(-3px);\n                box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);\n            }\n\n            /* 来源项目的数值增强显示 */\n            #${POPUP_CONTENT_ID} .source-total {\n                position: relative;\n                transition: all 0.3s ease;\n            }\n\n            #${POPUP_CONTENT_ID} .source-item:hover .source-total {\n                transform: scale(1.1);\n                text-shadow: 0 0 5px rgba(255, 165, 0, 0.5);\n            }\n\n            /* 添加打字机效果的类 */\n            .typewriter {\n                overflow: hidden;\n                border-right: .15em solid orange;\n                white-space: nowrap;\n                margin: 0 auto;\n                letter-spacing: .15em;\n                animation:\n                    typing 3.5s steps(40, end),\n                    blink-caret .75s step-end infinite;\n            }\n\n            @keyframes typing {\n                from { width: 0 }\n                to { width: 100% }\n            }\n\n            @keyframes blink-caret {\n                from, to { border-color: transparent }\n                50% { border-color: orange; }\n            }\n\n            #${POPUP_CONTENT_ID} #token-pie-chart:hover .pie-tooltip {\n                opacity: 1;\n                pointer-events: auto;\n            }\n        </style>\n\n        <div class=\"container\">\n            <div class=\"header\">\n                <h1>世界书统计与分析</h1>\n                <p><span id=\"character-name\" class=\"text-highlight\">${escapeHtml(stats.characterName)}</span> • 计算耗时: <span id=\"calc-time\" class=\"text-highlight\">${stats.calculationTime}</span>ms</p>\n            </div>\n\n            <div class=\"grid\">\n                <!-- 总览卡片 -->\n                <div class=\"card stat-card\">\n                    <div class=\"card-header\">\n                        <h2 class=\"card-title\">总 Tokens</h2>\n                        <i class=\"fas fa-calculator card-icon\"></i>\n                    </div>\n                    <div class=\"stat-value\">${stats.totalTokens.toLocaleString()}</div>\n                    <div class=\"stat-label\">该角色卡与绑定的世界书条目的总tokens</div>\n                </div>\n\n                <!-- 角色卡片 -->\n                <div class=\"card stat-card\">\n                    <div class=\"card-header\">\n                        <h2 class=\"card-title\">角色卡</h2>\n                        <i class=\"fas fa-user card-icon\"></i>\n                    </div>\n                    <div class=\"stat-value\">\n                        ${stats.characterCardTokens.toLocaleString()}\n                        <span style=\"font-size: 50%; font-style: italic;\">${stats.totalTokens > 0 ? (stats.characterCardTokens / stats.totalTokens * 100).toFixed(1) : 0}%</span>\n                    </div>\n                    <div class=\"stat-label\">角色描述、场景等内容的Token数</div>\n                </div>\n\n                <!-- 世界书卡片 -->\n                <div class=\"card stat-card\">\n                    <div class=\"card-header\">\n                        <h2 class=\"card-title\">世界书</h2>\n                        <i class=\"fas fa-book card-icon\"></i>\n                    </div>\n                    <div class=\"stat-value\">\n                        ${(stats.totalConstantTokens + stats.totalSelectiveTokens + stats.totalVectorizedTokens).toLocaleString()}\n                        <span style=\"font-size: 50%; font-style: italic;\">${stats.totalTokens > 0 ? ((stats.totalConstantTokens + stats.totalSelectiveTokens + stats.totalVectorizedTokens) / stats.totalTokens * 100).toFixed(1) : 0}%</span>\n                    </div>\n                    <div class=\"stat-label\">所有启用的世界书条目的Token总数</div>\n                </div>\n\n                <!-- Token类型分布 -->\n                <div class=\"card chart-card\">\n                    <div class=\"card-header\">\n                        <h2 class=\"card-title\">Token类型分布</h2>\n                        <i class=\"fas fa-chart-pie card-icon\"></i>\n                    </div>\n                    <div class=\"token-breakdown\">\n                        <div class=\"token-type constant\">\n                            <div class=\"token-type-value\">${stats.totalConstantTokens.toLocaleString()}</div>\n                            <div class=\"token-type-label\">蓝灯</div>\n                        </div>\n                        <div class=\"token-type selective\">\n                            <div class=\"token-type-value\">${stats.totalSelectiveTokens.toLocaleString()}</div>\n                            <div class=\"token-type-label\">绿灯</div>\n                        </div>\n                        <div class=\"token-type vectorized\">\n                            <div class=\"token-type-value\">${stats.totalVectorizedTokens.toLocaleString()}</div>\n                            <div class=\"token-type-label\">向量</div>\n                        </div>\n                    </div>\n                    <div id=\"token-pie-container\" style=\"height: 200px; position: relative; margin-top: 15px;\">\n                        ${renderTokenPieChart(stats)}\n                    </div>\n                </div>\n\n                <!-- 来源分布 -->\n                <div class=\"card chart-card\">\n                    <div class=\"card-header\">\n                        <h2 class=\"card-title\">来源分布</h2>\n                        <i class=\"fas fa-map-marker-alt card-icon\"></i>\n                    </div>\n                    <div id=\"source-bar-container\" style=\"height: 230px; position: relative; margin-top: 10px;\">\n                        ${renderSourceBarChart(stats)}\n                    </div>\n                </div>\n\n                <!-- 来源详细列表 -->\n                <div class=\"card wide-card\">\n                    <div class=\"card-header\">\n                        <h2 class=\"card-title\">来源详细数据</h2>\n                        <i class=\"fas fa-list-ul card-icon\"></i>\n                    </div>\n                    <div class=\"source-list\">\n                        ${renderSourceItems(stats)}\n                    </div>\n                </div>\n\n                <!-- 世界书列表 -->\n                <div class=\"card wide-card\" id=\"lorebook-list-section\">\n                    <div class=\"card-header\">\n                        <h2 class=\"card-title\">世界书列表</h2>\n                        <i class=\"fas fa-table card-icon\"></i>\n                    </div>\n                    <div class=\"table-responsive\">\n                        <table class=\"lorebook-table\">\n                            <thead>\n                                <tr>\n                                    <th>世界书名称</th>\n                                    <th>来源</th>\n                                    <th>蓝灯</th>\n                                    <th>绿灯</th>\n                                    <th>向量</th>\n                                    <th>总 Tokens</th>\n                                    <!-- <th>操作</th> --> <!-- 移除操作列 -->\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${renderLorebooksRows(stats)}\n                            </tbody>\n                        </table>\n                    </div>\n                     <p class=\"text-muted\" style=\"font-size: 0.85em; text-align: center; margin-top: 10px;\">双击表格行查看该世界书的详细条目信息 (包含未启用条目)。</p>\n                </div>\n\n                <!-- 条目详情部分 -->\n                <div class=\"card wide-card\" id=\"entry-details-section\" style=\"display: none;\">\n                    <div class=\"card-header\">\n                        <h2 class=\"card-title\" id=\"entry-details-title\">条目详情</h2>\n                        <button class=\"btn btn-outline\" id=\"back-to-lorebook-list\">返回列表</button>\n                    </div>\n                    <div id=\"entry-list-content-area\">\n                        <!-- 条目详情将在这里渲染 -->\n                    </div>\n                </div>\n\n                <!-- AI分析部分 -->\n                <div class=\"card wide-card\">\n                    <div class=\"card-header\">\n                        <h2 class=\"card-title\">AI 分析</h2>\n                        <i class=\"fas fa-robot card-icon\"></i>\n                    </div>\n                    <textarea id=\"ai-query-input\" rows=\"2\" placeholder=\"基于当前的统计数据，向AI提问... 例如：'哪个世界书的绿灯条目最多？' 或 '主要世界书的Token占比是多少？'\"></textarea>\n                    <div style=\"text-align: right;\">\n                        <button id=\"ai-ask-button\" class=\"btn btn-primary\">询问 AI</button>\n                        <button id=\"ai-clear-chat-button\" class=\"btn btn-outline\" style=\"margin-left: 10px;\">清空对话</button> <!-- [新增] 清空按钮 -->\n                    </div>\n                    <div id=\"ai-output-area\" class=\"ai-output\" style=\"display: none;\"></div>\n                </div>\n            </div>\n        </div>\n        `;\n\n        return htmlContent;\n    }\n\n    // Token分布饼图 - 使用HTML/CSS代替Chart.js\n    function renderTokenPieChart(stats) {\n        // 计算总的世界书Token和百分比 (基于启用的条目)\n        const lorebookTotal = stats.totalConstantTokens + stats.totalSelectiveTokens + stats.totalVectorizedTokens;\n        if (lorebookTotal === 0) return '<div style=\"text-align: center; padding: 40px; color: var(--text-secondary);\">(无启用的世界书Token数据)</div>';\n\n        const constPercent = ((stats.totalConstantTokens / lorebookTotal) * 100).toFixed(1);\n        const selectPercent = ((stats.totalSelectiveTokens / lorebookTotal) * 100).toFixed(1);\n        const vectPercent = ((stats.totalVectorizedTokens / lorebookTotal) * 100).toFixed(1);\n\n        // 构建CSS conic-gradient\n        let gradientString = 'conic-gradient(';\n        let currentPercent = 0;\n\n        if (parseFloat(constPercent) > 0) {\n            gradientString += `${COLOR_CONSTANT} 0% ${constPercent}%`;\n            currentPercent = parseFloat(constPercent);\n        }\n\n        if (parseFloat(selectPercent) > 0) {\n            if (currentPercent > 0) gradientString += ', ';\n            gradientString += `${COLOR_SELECTIVE} ${currentPercent}% ${currentPercent + parseFloat(selectPercent)}%`;\n            currentPercent += parseFloat(selectPercent);\n        }\n\n        if (parseFloat(vectPercent) > 0) {\n            if (currentPercent > 0) gradientString += ', ';\n            gradientString += `${COLOR_VECTORIZED} ${currentPercent}% 100%`;\n        }\n\n        gradientString += ')';\n\n        return `\n        <div style=\"display: flex; align-items: center; justify-content: center; height: 100%;\">\n            <div id=\"token-pie-chart\" class=\"token-pie-chart\" style=\"width: 130px; height: 130px; border-radius: 50%; background: ${gradientString}; border: 1px solid var(--border-color); position: relative; cursor: pointer;\"\n                data-constant=\"${stats.totalConstantTokens}\"\n                data-selective=\"${stats.totalSelectiveTokens}\"\n                data-vectorized=\"${stats.totalVectorizedTokens}\"\n                data-const-percent=\"${constPercent}\"\n                data-select-percent=\"${selectPercent}\"\n                data-vect-percent=\"${vectPercent}\">\n                <!-- 悬停tooltip -->\n                <div class=\"pie-tooltip\" style=\"position: absolute; top: -40px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.85rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap; z-index: 10;\">\n                    点击查看详细分布\n                </div>\n            </div>\n            <div style=\"margin-left: 20px;\">\n                <div style=\"display: flex; align-items: center; margin-bottom: 8px;\">\n                    <div style=\"width: 12px; height: 12px; background-color: ${COLOR_CONSTANT}; margin-right: 8px; border-radius: 2px;\"></div>\n                    <span>蓝灯: ${constPercent}%</span>\n                </div>\n                <div style=\"display: flex; align-items: center; margin-bottom: 8px;\">\n                    <div style=\"width: 12px; height: 12px; background-color: ${COLOR_SELECTIVE}; margin-right: 8px; border-radius: 2px;\"></div>\n                    <span>绿灯: ${selectPercent}%</span>\n                </div>\n                <div style=\"display: flex; align-items: center;\">\n                    <div style=\"width: 12px; height: 12px; background-color: ${COLOR_VECTORIZED}; margin-right: 8px; border-radius: 2px;\"></div>\n                    <span>向量: ${vectPercent}%</span>\n                </div>\n            </div>\n        </div>\n        `;\n    }\n\n    // 来源分布条形图 - 使用HTML/CSS代替Chart.js\n    function renderSourceBarChart(stats) {\n        const sourceData = [\n            { name: '主书', key: 'primary', color: STYLE_SOURCE_PRIMARY },\n            { name: '全局', key: 'global', color: STYLE_SOURCE_GLOBAL },\n            { name: '聊天', key: 'chat', color: STYLE_SOURCE_CHAT },\n            { name: '附加', key: 'additional', color: STYLE_SOURCE_ADDITIONAL }\n        ];\n\n        // 找出最大值以便缩放 (基于启用的条目)\n        let maxValue = 0;\n        sourceData.forEach(source => {\n            const data = stats.bySource[source.key];\n            const total = data.c + data.s + data.v;\n            if (total > maxValue) maxValue = total;\n        });\n\n        if (maxValue === 0) return '<div style=\"text-align: center; padding: 40px; color: var(--text-secondary);\">(无来源数据)</div>';\n\n        let barsHtml = '';\n\n        sourceData.forEach(source => {\n            const data = stats.bySource[source.key];\n            const totalSourceTokens = data.c + data.s + data.v;\n            // 计算高度，确保有值时至少有最小高度\n            const minHeightPercent = 5; // 最小高度百分比\n            const constHeight = data.c > 0 ? Math.max(minHeightPercent, (data.c / maxValue) * 100) : 0;\n            const selectHeight = data.s > 0 ? Math.max(minHeightPercent, (data.s / maxValue) * 100) : 0;\n            const vectHeight = data.v > 0 ? Math.max(minHeightPercent, (data.v / maxValue) * 100) : 0;\n\n            // 防止堆叠高度超过100% (虽然理论上不会，但保险起见)\n            const totalHeight = constHeight + selectHeight + vectHeight;\n            const scaleFactor = totalHeight > 100 ? 100 / totalHeight : 1;\n\n            const scaledConstHeight = constHeight * scaleFactor;\n            const scaledSelectHeight = selectHeight * scaleFactor;\n            const scaledVectHeight = vectHeight * scaleFactor;\n\n\n            barsHtml += `\n            <div class=\"source-bar-group\" style=\"display: flex; flex-direction: column; align-items: center; flex: 1; cursor: default;\" title=\"${source.name}: ${totalSourceTokens.toLocaleString()} Tokens (蓝:${data.c}, 绿:${data.s}, 黄:${data.v})\">\n                <div style=\"height: 160px; width: 50px; position: relative; margin-bottom: 10px; background-color: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden;\">\n                    <!-- 使用绝对定位，从底部向上堆叠 -->\n                    ${data.c > 0 ? `<div class=\"source-bar\" style=\"position: absolute; bottom: 0; left: 0; height: ${scaledConstHeight}%; width: 100%; background-color: ${COLOR_CONSTANT}; animation: growUp 1s forwards cubic-bezier(0.34, 1.56, 0.64, 1);\" title=\"蓝灯: ${data.c.toLocaleString()}\"></div>` : ''}\n                    ${data.s > 0 ? `<div class=\"source-bar\" style=\"position: absolute; bottom: ${scaledConstHeight}%; left: 0; height: ${scaledSelectHeight}%; width: 100%; background-color: ${COLOR_SELECTIVE}; animation: growUp 1s forwards cubic-bezier(0.34, 1.56, 0.64, 1);\" title=\"绿灯: ${data.s.toLocaleString()}\"></div>` : ''}\n                    ${data.v > 0 ? `<div class=\"source-bar\" style=\"position: absolute; bottom: ${scaledConstHeight + scaledSelectHeight}%; left: 0; height: ${scaledVectHeight}%; width: 100%; background-color: ${COLOR_VECTORIZED}; animation: growUp 1s forwards cubic-bezier(0.34, 1.56, 0.64, 1);\" title=\"向量: ${data.v.toLocaleString()}\"></div>` : ''}\n                </div>\n                <div class=\"source-bar-label\" style=\"font-size: 0.9rem; ${source.color} font-weight: bold;\">${source.name}</div>\n                <div class=\"source-bar-value\" style=\"font-size: 0.8rem; color: #aaa;\">${totalSourceTokens.toLocaleString()}</div>\n            </div>\n            `;\n        });\n\n        return `\n        <div style=\"display: flex; justify-content: space-around; align-items: flex-end; height: 100%;\">\n            ${barsHtml}\n        </div>\n        <div style=\"display: flex; justify-content: center; margin-top: 10px; gap: 15px;\">\n            <div style=\"display: flex; align-items: center;\">\n                <div style=\"width: 12px; height: 12px; background-color: ${COLOR_CONSTANT}; margin-right: 5px; border-radius: 2px;\"></div>\n                <span style=\"font-size: 0.8rem;\">蓝灯</span>\n            </div>\n            <div style=\"display: flex; align-items: center;\">\n                <div style=\"width: 12px; height: 12px; background-color: ${COLOR_SELECTIVE}; margin-right: 5px; border-radius: 2px;\"></div>\n                <span style=\"font-size: 0.8rem;\">绿灯</span>\n            </div>\n            <div style=\"display: flex; align-items: center;\">\n                <div style=\"width: 12px; height: 12px; background-color: ${COLOR_VECTORIZED}; margin-right: 5px; border-radius: 2px;\"></div>\n                <span style=\"font-size: 0.8rem;\">向量</span>\n            </div>\n        </div>\n        `;\n    }\n\n    // 渲染来源项目\n    function renderSourceItems(stats) {\n        const sources = [\n            { key: 'primary', name: '主书', colorClass: 'primary' },\n            { key: 'additional', name: '附加', colorClass: 'additional' },\n            { key: 'global', name: '全局', colorClass: 'global' },\n            { key: 'chat', name: '聊天', colorClass: 'chat' }\n        ];\n\n        let hasData = false;\n        let html = '';\n\n        sources.forEach(source => {\n            const data = stats.bySource[source.key];\n            const sourceTotal = data.c + data.s + data.v; // 基于统计\n\n            if (sourceTotal > 0 || data.books.length > 0) { // 只要有关联的书或有token就显示\n                hasData = true;\n                const booksDisplay = data.books.length > 0 ?\n                    data.books.join(', ') : '(无)'; // 显示关联的书名\n                const truncatedDisplay = booksDisplay.length > 60 ?\n                    booksDisplay.substring(0, 57) + '...' : booksDisplay;\n\n                html += `\n                <div class=\"source-item ${source.colorClass}\">\n                    <div class=\"source-header\">\n                        <span class=\"source-name\">${source.name}</span>\n                        <span class=\"source-total\">总计: ${sourceTotal.toLocaleString()}</span>\n                    </div>\n                    <span class=\"source-books\" title=\"${escapeHtml(booksDisplay)}\">包含世界书: ${escapeHtml(truncatedDisplay)}</span>\n                    <div class=\"source-breakdown\">\n                        <div class=\"source-breakdown-item\" style=\"background-color: rgba(75, 192, 192, 0.1); color: ${COLOR_CONSTANT};\">\n                            <div>蓝灯</div>\n                            <div style=\"font-weight: bold;\">${data.c.toLocaleString()}</div>\n                        </div>\n                        <div class=\"source-breakdown-item\" style=\"background-color: rgba(144, 238, 144, 0.1); color: ${COLOR_SELECTIVE};\">\n                            <div>绿灯</div>\n                            <div style=\"font-weight: bold;\">${data.s.toLocaleString()}</div>\n                        </div>\n                        <div class=\"source-breakdown-item\" style=\"background-color: rgba(255, 206, 86, 0.1); color: ${COLOR_VECTORIZED};\">\n                            <div>向量</div>\n                            <div style=\"font-weight: bold;\">${data.v.toLocaleString()}</div>\n                        </div>\n                    </div>\n                </div>\n                `;\n            }\n        });\n\n        if (!hasData) {\n            return '<p style=\"text-align: center; color: var(--text-secondary);\">无激活的世界书来源</p>';\n        }\n\n        return html;\n    }\n\n    // 渲染世界书表格行 - 移除详情按钮列\n    function renderLorebooksRows(stats) {\n        const sourceTextMap = {\n            primary: '主',\n            additional: '附',\n            global: '全',\n            chat: '聊'\n        };\n\n        const sourceColorMap = {\n            primary: STYLE_SOURCE_PRIMARY,\n            additional: STYLE_SOURCE_ADDITIONAL,\n            global: STYLE_SOURCE_GLOBAL,\n            chat: STYLE_SOURCE_CHAT\n        };\n\n        if (!stats.byLorebook || Object.keys(stats.byLorebook).length === 0) {\n            return '<tr><td colspan=\"6\" style=\"text-align: center; color: var(--text-secondary);\">无激活的世界书</td></tr>';\n        }\n\n        // 按总启用Token数排序\n        const lorebooks = Object.entries(stats.byLorebook).sort(([,a], [,b]) => b.t - a.t);\n        let html = '';\n\n        lorebooks.forEach(([name, data]) => {\n            const sourceText = sourceTextMap[data.src] || data.src;\n            const sourceStyle = sourceColorMap[data.src] || ''; // 获取颜色样式\n\n            const displayName = name.length > 30 ? name.substring(0, 27) + '...' : name;\n\n            html += `\n            <tr class=\"lorebook-row\" data-lorebook=\"${escapeHtml(name)}\" style=\"cursor: pointer;\" title=\"双击查看 '${escapeHtml(name)}' 的详细条目\">\n                <td title=\"${escapeHtml(name)}\">${escapeHtml(displayName)}</td>\n                <td style=\"${sourceStyle} font-weight: bold;\" title=\"${sourceTextMap[data.src] || data.src}\">${sourceText}</td>\n                <td style=\"${STYLE_CONSTANT_TEXT}\">${data.c.toLocaleString()}</td>\n                <td style=\"${STYLE_SELECTIVE_TEXT}\">${data.s.toLocaleString()}</td>\n                <td style=\"${STYLE_VECTORIZED_TEXT}\">${data.v.toLocaleString()}</td>\n                <td style=\"font-weight: bold;\">${data.t.toLocaleString()}</td>\n                <!-- <td>\n                    <button class=\"btn btn-outline view-entries-button\" data-lorebook=\"${escapeHtml(name)}\" style=\"padding: 2px 6px; font-size: 0.8em;\">详情</button>\n                </td> --> <!-- 移除详情按钮列 -->\n            </tr>\n            `;\n        });\n\n        return html;\n    }\n\n    // [修改] 条目详情HTML表格生成函数 (实现所有要求)\n    function renderEntryDetailsHtml(allEntries, lorebookName) {\n        logDebug(`renderEntryDetailsHtml: 开始为 '${lorebookName}' 渲染 ${allEntries.length} 个条目详情`);\n        if (!allEntries || allEntries.length === 0) {\n            return '<div style=\"text-align: center; padding: 20px; color: var(--text-secondary);\">(该世界书没有条目)</div>';\n        }\n\n        // 1. 分离和排序条目 (要求 2)\n        const enabledEntries = allEntries.filter(entry => entry.enabled);\n        const disabledEntries = allEntries.filter(entry => !entry.enabled);\n\n        // 按 Tokens 降序排序\n        const sortByTokensDesc = (a, b) => getEntryTokens(b) - getEntryTokens(a);\n        enabledEntries.sort(sortByTokensDesc);\n        disabledEntries.sort(sortByTokensDesc);\n\n        const sortedEntries = [...enabledEntries, ...disabledEntries];\n\n        // 2. 计算页脚统计数据 (要求 1)\n        let totalCount = allEntries.length;\n        let enabledCount = enabledEntries.length;\n        let disabledCount = disabledEntries.length;\n        let totalEnabledTokens = 0;\n        let enabledConstantCount = 0;\n        let enabledSelectiveCount = 0;\n        let enabledVectorizedCount = 0;\n\n        enabledEntries.forEach(entry => {\n            const entryTokens = getEntryTokens(entry); // 使用辅助函数\n            totalEnabledTokens += entryTokens;\n            if (entry.type === 'constant') enabledConstantCount++;\n            else if (entry.type === 'selective') enabledSelectiveCount++;\n            else if (entry.type === 'vectorized') enabledVectorizedCount++;\n        });\n\n        // 3. 构建表格 HTML (要求 3)\n        let tableHtml = `\n        <div class=\"entry-list-container\">\n            <table class=\"entry-list-table\">\n                <thead>\n                    <tr>\n                        <th>条目名称</th>\n                        <th>启用</th>\n                        <th>类型</th>\n                        <th>插入位置</th>\n                        <th>顺序</th>\n                        <th>扫描深度</th>\n                        <th>Tokens</th>\n                    </tr>\n                </thead>\n                <tbody>\n        `;\n\n        sortedEntries.forEach(entry => {\n            let typeText, typeStyle;\n            if (entry.type === 'constant') {\n                typeText = '蓝灯'; typeStyle = STYLE_CONSTANT_TEXT;\n            } else if (entry.type === 'selective') {\n                typeText = '绿灯'; typeStyle = STYLE_SELECTIVE_TEXT;\n            } else if (entry.type === 'vectorized') {\n                typeText = '向量'; typeStyle = STYLE_VECTORIZED_TEXT;\n            } else {\n                typeText = '未知'; typeStyle = '';\n            }\n\n            const entryTokens = getEntryTokens(entry);\n            const displayName = entry.comment || `(UID: ${entry.uid})`;\n            const truncatedName = displayName.length > 35 ? displayName.substring(0, 32) + '...' : displayName;\n            const isEnabled = entry.enabled;\n            const rowStyle = isEnabled ? '' : 'opacity: 0.6; font-style: italic;'; // 给禁用行添加样式\n\n            tableHtml += `\n                <tr style=\"${rowStyle}\">\n                    <td class=\"entry-comment\" title=\"${escapeHtml(displayName)} (UID: ${entry.uid})\">${escapeHtml(truncatedName)}</td>\n                    <td style=\"text-align: center;\">${isEnabled ? '<span style=\"color: #90EE90;\">是</span>' : '<span style=\"color: #FF4500;\">否</span>'}</td>\n                    <td style=\"${typeStyle}\">${typeText}</td>\n                    <td title=\"${escapeHtml(entry.position)}\">${escapeHtml(formatPosition(entry.position, entry.depth))}</td>\n                    <td style=\"text-align: right;\">${entry.order ?? '-'}</td>\n                    <td style=\"text-align: right;\">${formatScanDepth(entry.scan_depth)}</td>\n                    <td style=\"text-align: right;\">${entryTokens.toLocaleString()}</td>\n                </tr>\n            `;\n        });\n\n        tableHtml += `\n                </tbody>\n            </table>\n        </div>\n        `;\n\n        // 4. 构建页脚 HTML (要求 1)\n        const footerHtml = `\n        <div style=\"text-align: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; flex-wrap: wrap; gap: 5px 15px; font-size: 0.85em; color: var(--text-secondary);\">\n            <span>共 ${totalCount} 条目</span>\n            <span>已启用 ${enabledCount}</span>\n            <span>未启用 ${disabledCount}</span>\n            <span>有效 Tokens ${totalEnabledTokens.toLocaleString()}</span>\n            <span style=\"${STYLE_CONSTANT_TEXT}\">蓝灯 ${enabledConstantCount}</span>\n            <span style=\"${STYLE_SELECTIVE_TEXT}\">绿灯 ${enabledSelectiveCount}</span>\n            <span style=\"${STYLE_VECTORIZED_TEXT}\">向量 ${enabledVectorizedCount}</span>\n        </div>\n        `;\n\n        return tableHtml + footerHtml; // 组合表格和页脚\n    }\n\n    // 新增一个AI编辑按钮到条目详情页面\n    function addAiEditButton(entryDetailsSection, lorebookName) {\n        logDebug(`addAiEditButton: 为 ${lorebookName} 添加AI编辑按钮`);\n\n        // 先移除可能存在的旧按钮容器\n        entryDetailsSection.find('.card-header .buttons-container').remove();\n\n        // 为卡片标题栏添加AI编辑按钮\n        const aiEditButton = parent$(`<button class=\"btn btn-primary\" id=\"ai-edit-entries-button\" style=\"margin-right: 10px;\">\n            <i class=\"fas fa-magic\" style=\"margin-right: 5px;\"></i>AI 编辑条目\n        </button>`);\n\n        // 获取卡片标题栏和返回按钮\n        const cardHeader = entryDetailsSection.find('.card-header');\n        const backButton = cardHeader.find('#back-to-lorebook-list');\n\n        // 把返回按钮移除（如果它还在那里）\n        backButton.detach();\n\n        // 创建一个包装器来包含两个按钮\n        const buttonsContainer = parent$('<div class=\"buttons-container\" style=\"display: flex; align-items: center;\"></div>'); // 添加 class\n        buttonsContainer.append(aiEditButton);\n        buttonsContainer.append(backButton); // 重新添加返回按钮\n\n        // 放回到卡片标题栏\n        cardHeader.append(buttonsContainer);\n\n        // 保存当前世界书名称到全局变量\n        currentViewingLorebook = lorebookName;\n        logDebug(`已设置currentViewingLorebook为: ${currentViewingLorebook}`);\n\n        // 绑定点击事件\n        aiEditButton.off('click').on('click', function(e) { // 使用 .off().on() 避免重复绑定\n            e.preventDefault();\n            e.stopPropagation();\n            logDebug(\"AI编辑按钮被点击\");\n            openAiEditInterface();\n        });\n    }\n\n    // 打开AI编辑界面\n    async function openAiEditInterface() {\n        try {\n            logDebug(`openAiEditInterface: 尝试打开编辑界面，当前世界书: ${currentViewingLorebook}`);\n\n            if (!currentViewingLorebook) {\n                logDebug(\"错误: currentViewingLorebook未定义\");\n                parentToastr?.error('无法识别当前世界书');\n                return;\n            }\n\n            // 获取最新的完整条目数据用于编辑界面显示\n            let currentEntriesForEdit;\n            try {\n                currentEntriesForEdit = await TavernHelper.getLorebookEntries(currentViewingLorebook);\n            } catch (fetchError) {\n                 logDebug(`获取 '${currentViewingLorebook}' 条目失败:`, fetchError);\n                 parentToastr?.error(`获取世界书 \"${currentViewingLorebook}\" 的条目数据失败`);\n                 return;\n            }\n\n            const lorebookName = currentViewingLorebook;\n            logDebug(`加载世界书数据: ${lorebookName}, 条目数: ${currentEntriesForEdit.length}`);\n\n            // 创建编辑界面HTML\n            const editInterfaceHTML = `\n            <div class=\"ai-edit-container\" style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px;\">\n                <div class=\"edit-input-area\">\n                    <h3>编辑指令</h3>\n                    <textarea id=\"ai-edit-input\" rows=\"4\" placeholder=\"例如：'将所有蓝灯条目改为绿灯并添加关键词'或'优化ID为3的条目内容使其更简洁'\"\n                        class=\"form-control\" style=\"width: 100%; margin-bottom: 15px;\"></textarea>\n                    <button id=\"generate-edits-button\" class=\"btn btn-primary\">生成编辑建议</button>\n\n                    <div class=\"current-entries\" style=\"margin-top: 20px; max-height: 400px; overflow-y: auto;\">\n                        <h4>当前条目 (${currentEntriesForEdit.length})</h4>\n                        <div class=\"edit-entries-list\">\n                            ${currentEntriesForEdit.map(entry => {\n                                const entryTokens = getEntryTokens(entry); // 使用辅助函数\n                                return `\n                                <div class=\"entry-item\" style=\"margin-bottom: 5px; padding: 5px; border-bottom: 1px solid var(--border-color-subtle);\">\n                                    <div><strong>${escapeHtml(entry.comment || `UID: ${entry.uid}`)}</strong> (UID: ${entry.uid})</div>\n                                    <div style=\"color: var(--text-secondary); font-size: 0.85em;\">\n                                        启用: ${entry.enabled ? '<span style=\"color:#90EE90\">是</span>' : '<span style=\"color:#FF4500\">否</span>'} |\n                                        类型: <span style=\"color: ${entry.type === 'constant' ? COLOR_CONSTANT : (entry.type === 'selective' ? COLOR_SELECTIVE : COLOR_VECTORIZED)}\">\n                                            ${entry.type === 'constant' ? '蓝灯' : (entry.type === 'selective' ? '绿灯' : '向量')}\n                                        </span> |\n                                        Tokens: ${entryTokens}\n                                    </div>\n                                </div>\n                            `}).join('')}\n                        </div>\n                    </div>\n                </div>\n                <div class=\"edit-preview-area\">\n                    <h3>编辑预览</h3>\n                    <div id=\"ai-edit-preview\" style=\"background: var(--bg-dark); padding: 15px; border-radius: 8px; height: 400px; overflow-y: auto;\">\n                        <p class=\"text-muted\">AI生成的编辑建议将显示在这里...</p>\n                    </div>\n                    <div style=\"text-align: right; margin-top: 15px;\">\n                        <button id=\"cancel-edits-button\" class=\"btn btn-outline\" style=\"margin-right: 8px;\">取消</button>\n                        <button id=\"apply-edits-button\" class=\"btn btn-primary\" disabled>应用修改</button>\n                    </div>\n                </div>\n            </div>\n            `;\n\n            // 显示编辑界面\n            callGenericPopup(editInterfaceHTML, POPUP_TYPE.DISPLAY, `AI编辑 - ${lorebookName}`, { wide: true, large: true });\n\n            // 绑定事件处理\n            parent$('#generate-edits-button').off('click').on('click', async function() {\n                const editInstruction = parent$('#ai-edit-input').val();\n                if (!editInstruction) {\n                    parentToastr?.warning('请输入编辑指令');\n                    return;\n                }\n\n                parent$(this).prop('disabled', true).html('<i class=\"fas fa-spinner fa-spin\"></i> 生成中...');\n                parent$('#ai-edit-preview').html('<p class=\"text-muted\"><i class=\"fas fa-spinner fa-spin\"></i> AI正在生成编辑建议...</p>');\n\n                // 获取最新的条目数据用于生成编辑建议\n                let entriesForGeneration;\n                 try {\n                     entriesForGeneration = await TavernHelper.getLorebookEntries(lorebookName);\n                 } catch (fetchError) {\n                     parent$('#ai-edit-preview').html(`<p style=\"color: red;\">获取最新条目数据失败: ${fetchError.message}</p>`);\n                     parent$('#generate-edits-button').prop('disabled', false).html('生成编辑建议');\n                     return;\n                 }\n\n                try {\n                    // [修改] 调用修改后的 generateAiEdits\n                    const editPreview = await generateAiEdits(entriesForGeneration, editInstruction, lorebookName);\n                    parent$('#ai-edit-preview').html(editPreview.html);\n                    // 如果返回了手动输入区域，需要绑定手动解析按钮事件\n                    if (parent$('#parse-manual-json').length > 0) {\n                         parent$('#parse-manual-json').off('click').on('click', function() {\n                             const manualJson = parent$('#manual-json-input').val();\n                             try {\n                                 const parsedEdits = JSON.parse(manualJson);\n                                 if (Array.isArray(parsedEdits) && parsedEdits.every(e => e && typeof e === 'object' && e.uid !== undefined)) {\n                                     // 验证并构建预览\n                                     const mergedEditsData = validateAndMergeEdits(parsedEdits, entriesForGeneration);\n                                     const previewHTML = buildEditPreviewHTML(mergedEditsData, entriesForGeneration, \"手动解析JSON\");\n                                     parent$('#ai-edit-preview').html(previewHTML);\n                                     parent$('#apply-edits-button').prop('disabled', mergedEditsData.length === 0).data('edits', mergedEditsData);\n                                     parentToastr?.success(\"手动JSON解析成功！\");\n                                 } else {\n                                     throw new Error(\"JSON格式不正确或缺少uid\");\n                                 }\n                             } catch (parseError) {\n                                 parentToastr?.error(`手动JSON解析失败: ${parseError.message}`);\n                             }\n                         });\n                    } else {\n                         parent$('#apply-edits-button').prop('disabled', !editPreview.edits || editPreview.edits.length === 0).data('edits', editPreview.edits);\n                    }\n                } catch (error) {\n                    parent$('#ai-edit-preview').html(`<p style=\"color: red;\">生成编辑时出错: ${error.message}</p>`);\n                     parent$('#apply-edits-button').prop('disabled', true).data('edits', []); // 清空数据\n                } finally {\n                    parent$('#generate-edits-button').prop('disabled', false).html('生成编辑建议');\n                }\n            });\n\n            parent$('#apply-edits-button').off('click').on('click', async function() {\n                const editsToApply = parent$(this).data('edits');\n                if (!editsToApply || !Array.isArray(editsToApply) || !editsToApply.length) {\n                    parentToastr?.warning('没有可应用的修改。');\n                    return;\n                }\n\n                parent$(this).prop('disabled', true).html('<i class=\"fas fa-spinner fa-spin\"></i> 应用中...');\n                parent$('#cancel-edits-button').prop('disabled', true); // 禁用取消按钮\n\n                try {\n                    await TavernHelper.setLorebookEntries(lorebookName, editsToApply);\n                    parentToastr?.success(`成功应用了 ${editsToApply.length} 个条目的修改`);\n\n                    // 关闭编辑弹窗\n                    const editDialog = parent$(this).closest('dialog');\n                    if (editDialog.length > 0 && typeof editDialog[0].close === 'function') {\n                         editDialog[0].close('applied');\n                    }\n\n                    // 延迟一下再刷新主弹窗的条目列表\n                    setTimeout(() => refreshEntryList(lorebookName), 300);\n\n                } catch (error) {\n                    parentToastr?.error(`应用修改时出错: ${error.message}`);\n                    parent$('#apply-edits-button').prop('disabled', false).html('应用修改');\n                     parent$('#cancel-edits-button').prop('disabled', false);\n                }\n            });\n\n            parent$('#cancel-edits-button').off('click').on('click', function() {\n                const editDialog = parent$(this).closest('dialog');\n                 if (editDialog.length > 0 && typeof editDialog[0].close === 'function') {\n                     editDialog[0].close('cancelled');\n                 }\n            });\n        } catch (error) {\n            logDebug(`openAiEditInterface错误: ${error.message}`);\n            parentToastr?.error(`打开AI编辑界面时出错: ${error.message}`);\n        }\n    }\n\n    // 刷新条目列表 (在主弹窗中)\n    async function refreshEntryList(lorebookName) {\n        logDebug(`refreshEntryList: 刷新主弹窗中 ${lorebookName} 的条目列表`);\n\n        // 找到主弹窗的内容容器\n        const mainPopupContent = parent$(`dialog[open]:not([closing]) #${POPUP_CONTENT_ID}`);\n        if (mainPopupContent.length === 0) {\n            logDebug(\"refreshEntryList: 未找到主弹窗，无法刷新。\");\n            return;\n        }\n\n        const entryDetailsSection = mainPopupContent.find('#entry-details-section');\n        if (entryDetailsSection.is(':visible') && currentViewingLorebook === lorebookName) {\n            logDebug(`refreshEntryList: 详情页可见，正在刷新 '${lorebookName}'`);\n            const entryDetailsTitle = entryDetailsSection.find('#entry-details-title');\n            const entryListContentArea = entryDetailsSection.find('#entry-list-content-area');\n\n            // 显示加载状态\n            entryListContentArea.html('<div style=\"text-align:center; padding: 20px;\"><i class=\"fa-solid fa-spinner fa-spin\"></i> 刷新条目数据中...</div>');\n            entryDetailsTitle.text(`'${escapeHtml(lorebookName)}' 条目详情 (刷新中...)`);\n\n            try {\n                const allEntries = await TavernHelper.getLorebookEntries(lorebookName);\n                entryListContentArea.html(renderEntryDetailsHtml(allEntries, lorebookName));\n                entryDetailsTitle.text(`'${escapeHtml(lorebookName)}' 条目详情`);\n                // 重新添加编辑按钮\n                addAiEditButton(entryDetailsSection, lorebookName);\n                logDebug(`refreshEntryList: '${lorebookName}' 刷新完成`);\n            } catch (error) {\n                 console.error(`刷新世界书 '${lorebookName}' 条目时出错:`, error);\n                 parentToastr?.error(`刷新 '${lorebookName}' 条目失败: ${error.message}`);\n                 entryListContentArea.html(`<div style=\"color: red; padding: 15px;\">刷新条目数据失败: ${escapeHtml(error.message)}</div>`);\n                 entryDetailsTitle.text(`'${escapeHtml(lorebookName)}' 条目详情 (刷新错误)`);\n            }\n        } else {\n             logDebug(`refreshEntryList: 详情页不可见或世界书不匹配，跳过刷新。 (当前查看: ${currentViewingLorebook}, 请求刷新: ${lorebookName})`);\n        }\n\n        // 可选：同时刷新概览数据（如果应用修改可能影响概览）\n        // stats = await calculateTokenStats();\n        // mainPopupContent.html(createBeautifiedHtml(stats)); // 这会完全重绘，可能导致闪烁和丢失当前视图\n        // 更优的方式是只更新受影响的概览卡片和列表，但这比较复杂\n    }\n\n\n    // 生成AI编辑建议 (Modified to send full metadata)\n    async function generateAiEdits(entries, instruction, lorebookName) {\n        logDebug(`generateAiEdits: 为 ${lorebookName} 生成编辑建议，指令: ${instruction.substring(0, 50)}...`);\n        logDebug(`generateAiEdits: 将发送 ${entries.length} 个条目的完整元数据`);\n\n        // [修改] 构建包含完整元数据的 Prompt\n        // 注意：发送完整内容可能导致Token超标，这里我们发送所有元数据字段，内容字段仍用预览或省略\n        const entriesForPrompt = entries.map(entry => {\n            // 创建一个副本，移除或截断可能过长的 content 字段\n            const entryCopy = { ...entry };\n            if (entryCopy.content && entryCopy.content.length > 200) { // 限制内容长度，避免过大payload\n                entryCopy.content_preview = entryCopy.content.substring(0, 197) + '...';\n                delete entryCopy.content; // 移除原始长内容\n            } else if (entryCopy.content === null || entryCopy.content === undefined) {\n                 entryCopy.content = ''; // 确保 content 字段存在且为字符串\n            }\n            // 确保 depth 是数字或 null\n             if (entryCopy.depth !== null && typeof entryCopy.depth !== 'number') {\n                 entryCopy.depth = null; // 或者尝试解析 parseInt(entryCopy.depth, 10) || null;\n             }\n             // 确保 order 是数字\n             if (typeof entryCopy.order !== 'number') {\n                 entryCopy.order = parseInt(entryCopy.order, 10) || 0; // 提供默认值\n             }\n             // 确保 scan_depth 是数字或特定字符串\n             if (entryCopy.scan_depth !== 'same_as_global' && typeof entryCopy.scan_depth !== 'number') {\n                 entryCopy.scan_depth = 'same_as_global'; // 提供默认值\n             }\n             // 其他字段类型也应类似处理以增加健壮性...\n\n            return entryCopy;\n        });\n\n\n        const prompt = `你是一个专业的世界书条目编辑助手。请根据以下指令修改世界书\"${lorebookName}\"中的条目:\n\n    指令: ${instruction}\n\n    以下是当前条目列表（JSON格式，包含完整的元数据，content字段可能被截断为content_preview）:\n    \\`\\`\\`json\n    ${JSON.stringify(entriesForPrompt, null, 2)}\n    \\`\\`\\`\n\n    你必须按以下格式返回修改后的条目数据（仅包含需要修改的条目和字段）：\n    \\`\\`\\`json\n    [\n      {\n        \"uid\": 条目ID(必须保留原uid),\n        \"修改的字段1\": \"新值\", // 例如: \"enabled\": false, \"order\": 10, \"scan_depth\": 5, \"depth\": 3\n        \"修改的字段2\": \"新值\"\n        // 只包含你需要修改的字段，不要包含未修改的字段\n      },\n      {\n        \"uid\": 另一个条目ID,\n        \"修改的字段\": \"新值\"\n      }\n    ]\n    \\`\\`\\`\n\n    请确保：\n    1. 返回的内容必须包含格式正确的JSON数组。\n    2. 每个对象必须包含 \"uid\" 字段。\n    3. 将JSON代码块放在 \\`\\`\\`json 和 \\`\\`\\` 之间。\n    4. 在回复中必须包含一个且只有一个符合上述要求的JSON代码块。\n    5. 只返回你需要修改的条目，如果某个条目没有变化，不要包含在返回的JSON中。\n    6. 返回的字段值必须是有效的类型（例如，'enabled' 必须是 boolean，'key' 必须是 string[]，'order'/'depth'/'scan_depth' 必须是 number 或对应类型）。\n\n    在返回JSON前，可以简短说明你的修改策略，但确保JSON格式正确且完整。`;\n\n        try {\n            // 检查 TavernHelper.generateRaw 是否可用\n            if (typeof TavernHelper?.generateRaw !== 'function') {\n                throw new Error(\"AI功能所需的 TavernHelper.generateRaw 未找到\");\n            }\n\n            logDebug(\"使用 generateRaw 发送请求...\");\n            // 使用 generateRaw 发送纯净的指令\n            const aiResponse = await TavernHelper.generateRaw({\n                ordered_prompts: [\n                    { role: 'user', content: prompt }\n                ],\n                // 可选配置: 增加允许的回复长度，因为输入的prompt变长了\n                max_new_tokens: 2048, // 酌情调整\n                // temperature: 0.5,\n            });\n            logDebug(\"generateRaw 请求完成，收到响应。\");\n\n            // --- JSON 提取逻辑 (保持不变) ---\n            let parsedEdits = [];\n            let jsonExtracted = false;\n            let extractedJsonString = null;\n            let extractionMethod = '';\n\n            const jsonBlockMatch = aiResponse.match(/```(?:json)?\\s*(\\[[\\s\\S]*?\\])\\s*```/);\n            if (jsonBlockMatch && jsonBlockMatch[1]) {\n                extractedJsonString = jsonBlockMatch[1];\n                try {\n                    parsedEdits = JSON.parse(extractedJsonString);\n                    if (Array.isArray(parsedEdits)) {\n                        jsonExtracted = true;\n                        extractionMethod = 'Standard Code Block';\n                        logDebug(\"使用标准代码块格式成功提取JSON\");\n                    } else {\n                        console.warn(\"标准代码块解析出的JSON不是数组:\", parsedEdits);\n                        parsedEdits = [];\n                    }\n                } catch (e) {\n                    console.warn(\"标准代码块JSON解析失败:\", e.message, \"提取到的字符串:\", extractedJsonString);\n                }\n            }\n\n            if (!jsonExtracted) {\n                const arrayMatch = aiResponse.match(/(\\[[\\s\\S]*?\\])/);\n                if (arrayMatch && arrayMatch[1]) {\n                    extractedJsonString = arrayMatch[1];\n                    try {\n                        const cleanedJsonString = extractedJsonString\n                            .replace(/,\\s*([\\}\\]])/g, '$1')\n                            .replace(/(\\/\\*[\\s\\S]*?\\*\\/|\\/\\/.*$)/gm, '');\n                        parsedEdits = JSON.parse(cleanedJsonString);\n                         if (Array.isArray(parsedEdits)) {\n                            jsonExtracted = true;\n                            extractionMethod = 'Fallback Array Match';\n                            logDebug(\"通过备选方法成功提取JSON\");\n                        } else {\n                            console.warn(\"备选方法解析出的JSON不是数组:\", parsedEdits);\n                            parsedEdits = [];\n                        }\n                    } catch (e) {\n                        console.warn(\"备选JSON提取失败:\", e.message, \"提取到的字符串:\", extractedJsonString);\n                    }\n                }\n            }\n\n            // --- 处理提取结果 (手动输入部分保持不变) ---\n            if (!jsonExtracted) {\n                logDebug(\"未找到完整JSON格式，提供手动输入选项\");\n                console.warn(\"AI回复内容:\", aiResponse);\n                 const previewHTML = `\n                <div>\n                    <h4>无法自动解析AI回复</h4>\n                    <p>未能从AI回复中提取有效的JSON数据。以下是AI的完整回复：</p>\n                    <div style=\"background-color: var(--bg-dark); padding: 15px; border-radius: 8px; margin: 10px 0; max-height: 200px; overflow-y: auto; white-space: pre-wrap; font-size: 0.9em;\">${escapeHtml(aiResponse)}</div>\n                    <p>请尝试重新生成，或使用更清晰的指令。您也可以手动输入符合格式的JSON：</p>\n                    <textarea id=\"manual-json-input\" rows=\"8\" style=\"width: 100%; background-color: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; font-family: monospace;\" placeholder='[{\"uid\": 1, \"type\": \"selective\", \"comment\": \"New Comment\", \"order\": 5}]'></textarea>\n                    <div style=\"text-align: right; margin-top: 10px;\">\n                        <button id=\"parse-manual-json\" class=\"btn btn-primary\">解析手动输入的JSON</button>\n                    </div>\n                </div>`;\n                return { html: previewHTML, edits: [] };\n            }\n\n            logDebug(`JSON 提取成功 (方法: ${extractionMethod})，解析出 ${parsedEdits.length} 个潜在修改。`);\n\n            // --- 验证并合并编辑 (保持不变, 它会处理新增的字段) ---\n            const mergedEditsData = validateAndMergeEdits(parsedEdits, entries);\n            logDebug(`最终将应用的修改 (${mergedEditsData.length} 个条目):`, mergedEditsData);\n\n            // 构建预览HTML (保持不变, 它会显示新增的字段)\n            const previewHTML = buildEditPreviewHTML(mergedEditsData, entries, aiResponse);\n            return { html: previewHTML, edits: mergedEditsData };\n\n        } catch (error) {\n            console.error(\"生成AI编辑建议出错:\", error);\n            return { html: `<p style=\"color: red;\">生成编辑建议时出错: ${escapeHtml(error.message)}</p>`, edits: [] };\n        }\n    }\n\n    // [新增] 验证和合并编辑的辅助函数\n    function validateAndMergeEdits(parsedEdits, originalEntries) {\n         if (!Array.isArray(parsedEdits)) {\n             console.warn(\"validateAndMergeEdits: 输入的不是数组:\", parsedEdits);\n             return [];\n         }\n         const validEdits = [];\n         parsedEdits.forEach(edit => {\n             if (!edit || typeof edit !== 'object' || edit.uid === undefined) {\n                 console.warn(\"过滤掉无效的编辑对象 (缺少uid或非对象):\", edit);\n                 return; // 跳过这个无效对象\n             }\n             const originalEntry = originalEntries.find(e => e.uid === edit.uid);\n             if (!originalEntry) {\n                 console.warn(`过滤掉无效的编辑对象 (未找到原始条目 uid: ${edit.uid}):`, edit);\n                 return; // 跳过这个无效对象\n             }\n\n             // 创建一个新的对象，只包含有效的、实际发生变化的修改\n             const updateData = { uid: edit.uid };\n             let hasChanged = false;\n             for (const key in edit) {\n                 if (key !== 'uid' && Object.prototype.hasOwnProperty.call(edit, key)) {\n                     // 比较新旧值 (使用JSON.stringify处理对象和数组的比较)\n                     // 注意：直接比较可能因类型不匹配（如 null vs 0）而误判，但 setLorebookEntries 应该能处理\n                     if (JSON.stringify(edit[key]) !== JSON.stringify(originalEntry[key])) {\n                         updateData[key] = edit[key];\n                         hasChanged = true;\n                     }\n                 }\n             }\n             // 只有当确实有字段发生变化时才添加到最终列表\n             if (hasChanged) {\n                 validEdits.push(updateData);\n             } else {\n                 logDebug(`编辑对象 for uid ${edit.uid} 未包含实际变化，已忽略:`, edit);\n             }\n         });\n\n         if (validEdits.length === 0 && parsedEdits.length > 0) {\n             console.warn(\"AI返回了编辑数据，但经过验证后没有有效的修改。\");\n         }\n         return validEdits;\n    }\n\n\n    // --- 依赖的辅助函数 (需要放在脚本的其他地方或确保可用) ---\n\n    // 构建编辑预览HTML (需要确保这个函数在你的脚本中定义了)\n    function buildEditPreviewHTML(editsToApply, originalEntries, aiResponse = '') {\n        let summary = '';\n        if (aiResponse) {\n            // 尝试提取AI回复中 ```json 之前的部分作为摘要\n            const jsonStartIndex = aiResponse.indexOf('```'); // 寻找第一个代码块开始\n            const potentialSummary = jsonStartIndex !== -1 ? aiResponse.substring(0, jsonStartIndex).trim() : aiResponse.trim();\n            // 限制摘要长度，避免过长\n            summary = potentialSummary.length > 0 && potentialSummary.length < 500\n                ? potentialSummary.split('\\n\\n')[0] // 取第一段\n                : '(AI已生成编辑建议)';\n            summary = summary || '(AI已生成编辑建议)'; // 确保有默认值\n        }\n\n        if (!editsToApply || editsToApply.length === 0) {\n            return `\n            <div>\n                <h4>修改摘要</h4>\n                <p>${escapeHtml(summary)}</p>\n                <h4>未检测到有效的修改</h4>\n                <p class=\"text-muted\">AI未能提供可应用的修改建议，或者提供的建议无效/未改变任何内容。</p>\n                ${aiResponse ? `<div style=\"font-size: 0.8em; margin-top:10px; max-height: 150px; overflow-y: auto; background: var(--bg-darker); padding: 5px; border: 1px solid var(--border-color-subtle); border-radius: 4px;\"><strong>原始AI回复:</strong><br>${escapeHtml(aiResponse)}</div>` : ''}\n            </div>`;\n        }\n\n        return `\n        <div>\n            <h4>修改摘要</h4>\n            <p>${escapeHtml(summary)}</p>\n\n            <h4>将修改 ${editsToApply.length} 个条目</h4>\n            <div class=\"edit-preview-list\" style=\"max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color-subtle); padding: 10px; border-radius: 6px; background: var(--bg-dark);\">\n                ${editsToApply.map(edit => {\n                    const original = originalEntries.find(e => e.uid === edit.uid);\n                    if (!original) return ''; // 安全检查\n\n                    const changesHtml = Object.keys(edit)\n                        .filter(key => key !== 'uid') // 排除uid本身\n                        .map(key => {\n                            const originalValue = original[key];\n                            const newValue = edit[key];\n                            // 再次确认值不同才显示 (validateAndMergeEdits已做过，这里是双重保险)\n                            if (JSON.stringify(originalValue) !== JSON.stringify(newValue)) {\n                                return `\n                                    <div style=\"margin-top: 5px; padding-left: 15px; border-left: 2px solid var(--border-color);\">\n                                        <span style=\"color: var(--text-secondary); font-weight: bold;\">${escapeHtml(key)}:</span>\n                                        <div style=\"display: flex; flex-direction: column; margin-top: 2px;\">\n                                            <span style=\"text-decoration: line-through; color: #FF6384; margin-right: 5px; font-size: 0.9em; opacity: 0.8;\">${formatValue(originalValue)}</span>\n                                            <div style=\"display: flex; align-items: center;\">\n                                                <span style=\"color: #aaa; margin: 0 5px;\">→</span>\n                                                <span style=\"color: #4BC0C0; font-weight: bold; font-size: 0.9em;\">${formatValue(newValue)}</span>\n                                            </div>\n                                        </div>\n                                    </div>\n                                `;\n                            }\n                            return ''; // 值相同，不显示\n                        }).join('');\n\n                    // 如果没有检测到实际变化，则不显示该条目 (理论上不会发生，因为editsToApply已过滤)\n                    if (!changesHtml) return '';\n\n                    return `\n                    <div class=\"edit-preview-item\" style=\"margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed var(--border-color-subtle);\">\n                        <div><strong>条目:</strong> ${escapeHtml(original.comment || `UID: ${original.uid}`)} (UID: ${original.uid})</div>\n                        ${changesHtml}\n                    </div>\n                    `;\n                }).join('')}\n            </div>\n        </div>\n        `;\n    }\n\n    // 格式化值显示 (需要确保这个函数在你的脚本中定义了)\n    function formatValue(value) {\n        const maxLength = 80; // 预览中显示的最大长度\n        let displayValue;\n\n        if (value === null || value === undefined) {\n            return '<em style=\"color: var(--text-secondary);\">(空)</em>';\n        } else if (typeof value === 'boolean') {\n            return value ? '<span style=\"color: #90EE90;\">是</span>' : '<span style=\"color: #FF4500;\">否</span>';\n        } else if (Array.isArray(value)) {\n            // 对数组元素也进行格式化和截断\n            const formattedArray = value.map(v => formatValue(v)); // 递归格式化\n            displayValue = `[${formattedArray.join(', ')}]`;\n            // 注意：这里可能导致最终字符串很长，但截断数组本身比较复杂\n        } else if (typeof value === 'object') {\n            displayValue = JSON.stringify(value); // 对象直接显示JSON\n        } else {\n            displayValue = String(value).replace(/\\n/g, '↵'); // 替换换行符以便单行显示\n        }\n\n        const escapedValue = escapeHtml(displayValue);\n        if (escapedValue.length > maxLength) {\n            // 使用 pre-wrap 保留可能的换行符，同时允许文本换行\n            return `<span title=\"${escapedValue}\" style=\"white-space: pre-wrap; word-break: break-all;\">${escapedValue.substring(0, maxLength - 3)}...</span>`;\n        } else {\n            return `<span style=\"white-space: pre-wrap; word-break: break-all;\">${escapedValue}</span>`;\n        }\n    }\n\n    // --- AI Analysis (Modified for generateRaw, detailed data, and history) ---\n    async function handleAiAnalysis(contentContainer$, stats, query) {\n        logDebug(`handleAiAnalysis: 开始处理 AI 分析请求 (使用 generateRaw)，查询: \"${query}\"`);\n        const outputArea = contentContainer$.find('#ai-output-area');\n        const aiButton = contentContainer$.find('#ai-ask-button');\n        const aiQueryInput = contentContainer$.find('#ai-query-input');\n        const clearButton = contentContainer$.find('#ai-clear-chat-button');\n\n        outputArea.html('<div style=\"padding: 10px;\"><i class=\"fas fa-spinner fa-spin\"></i> AI 正在思考...</div>').addClass('show').css('display', 'block');\n        aiButton.prop('disabled', true);\n        aiQueryInput.prop('disabled', true);\n        clearButton.prop('disabled', true);\n\n        try {\n            // 获取各个lorebook的详细条目元数据\n            const lorebooksWithEntries = {};\n            for (const [name, data] of Object.entries(stats.byLorebook)) {\n                try {\n                    // 获取当前lorebook的所有条目\n                    const entries = await TavernHelper.getLorebookEntries(name);\n                    \n                    // 精简条目数据，只保留必要的元数据，完全不包含内容\n                    const processedEntries = entries.map(entry => ({\n                        uid: entry.uid,\n                        type: entry.type,              // constant, selective, vectorized\n                        enabled: entry.enabled,        // 是否启用\n                        comment: entry.comment,        // 条目名称/备注\n                        order: entry.order,            // 排序顺序\n                        position: entry.position,      // 插入位置\n                        scan_depth: entry.scan_depth,  // 扫描深度\n                        depth: entry.depth,            // 插入深度\n                        tk: getEntryTokens(entry),     // token数量\n                        // 如果是selective或vectorized类型，包含关键词\n                        key: entry.key || [],\n                        // 不包含content或content_preview\n                    }));\n                    \n                    lorebooksWithEntries[name] = {\n                        source: data.src,\n                        constantTokens: data.c,\n                        selectiveTokens: data.s,\n                        vectorizedTokens: data.v,\n                        totalEnabledTokens: data.t,\n                        entries: processedEntries\n                    };\n                } catch (error) {\n                    logDebug(`获取世界书 '${name}' 条目出错:`, error);\n                    lorebooksWithEntries[name] = {\n                        source: data.src,\n                        constantTokens: data.c,\n                        selectiveTokens: data.s,\n                        vectorizedTokens: data.v,\n                        totalEnabledTokens: data.t,\n                        entries: [],\n                        error: error.message\n                    };\n                }\n            }\n\n            const dataForAI = {\n                summary: {\n                    charName: stats.characterName,\n                    charTk: stats.characterCardTokens,\n                    totalConstTk: stats.totalConstantTokens,\n                    totalSeleTk: stats.totalSelectiveTokens,\n                    totalVectTk: stats.totalVectorizedTokens,\n                    totalTk: stats.totalTokens\n                },\n                lorebooks: lorebooksWithEntries // 现在包含了详细条目元数据\n            };\n\n            // 构建 Prompt 和有序提示列表 (包含历史)\n            const currentQueryContent = `基于以下 Token 统计数据 (JSON 格式，包含角色卡、各个世界书的统计和所有条目的元数据):\\n\\`\\`\\`json\\n${JSON.stringify(dataForAI, null, 1)}\\n\\`\\`\\`\\n请简洁回答用户问题。重要提示：\\n- 'selective' (绿灯) Token 只有在其关键词在最近聊天历史中匹配时才会被包含在上下文中。\\n- 'vectorized' (向量) Token 是基于语义相似度激活的，也可能结合关键词。\\n- 这里显示的是绿灯和向量条目如果被激活时的最大潜在 Token 数。\\n- 你现在可以访问每个条目的详细元数据，包括启用状态、插入位置、关键词等信息。\\n\\n用户问题: \"${query}\"\\n\\n回答:`;\n            \n            // 余下的代码保持不变...\n            const currentUserPrompt = { role: 'user', content: currentQueryContent };\n            const promptsToSend = [...aiAnalysisHistory];\n            promptsToSend.push(currentUserPrompt);\n\n            if (promptsToSend.length > MAX_AI_HISTORY) {\n                promptsToSend.splice(0, promptsToSend.length - MAX_AI_HISTORY);\n                logDebug(`AI分析历史已截断，保留最近 ${MAX_AI_HISTORY} 条消息`);\n            }\n\n            logDebug(\"handleAiAnalysis: 发送给 AI 的 Prompts (数据已简化):\", promptsToSend);\n\n            if (typeof TavernHelper?.generateRaw !== 'function') {\n                throw new Error(\"AI 功能依赖的 TavernHelper.generateRaw 未找到。\");\n            }\n            \n            // 可能需要增加输出token限制，因为输入更大了\n            const result = await TavernHelper.generateRaw({\n                ordered_prompts: promptsToSend,\n                max_new_tokens: 1024, // 增加输出长度限制\n            });\n            \n            // 更新对话历史\n            aiAnalysisHistory.push(currentUserPrompt);\n            aiAnalysisHistory.push({ role: 'assistant', content: result || \"(AI 没有提供回答)\" });\n            \n            if (aiAnalysisHistory.length > MAX_AI_HISTORY) {\n                aiAnalysisHistory.splice(0, aiAnalysisHistory.length - MAX_AI_HISTORY);\n            }\n            \n            // 显示结果逻辑保持不变\n            outputArea.html('');\n            const typewriterElem = parent$('<div class=\"typewriter\"></div>');\n            outputArea.append(typewriterElem);\n            const text = result || \"(AI 没有提供回答)\";\n            let i = 0;\n            const typeSpeed = 20;\n\n            function typeWriter() {\n                if (i < text.length) {\n                    typewriterElem.append(document.createTextNode(text.charAt(i)));\n                    i++;\n                    outputArea.scrollTop(outputArea[0].scrollHeight);\n                    setTimeout(typeWriter, typeSpeed);\n                } else {\n                    setTimeout(() => {\n                        typewriterElem.removeClass('typewriter');\n                        typewriterElem.css({\n                            'border-right': 'none',\n                            'white-space': 'pre-wrap',\n                            'width': 'auto'\n                        });\n                        outputArea.scrollTop(outputArea[0].scrollHeight);\n                    }, 500);\n                }\n            }\n            typeWriter();\n\n        } catch (error) {\n            console.error(\"AI 分析出错:\", error);\n            outputArea.html(`<p style=\"color: red;\">AI 分析时出错: ${escapeHtml(error.message)}</p>`);\n        } finally {\n            logDebug(\"handleAiAnalysis: AI 处理完成或失败。\");\n            aiButton.prop('disabled', false);\n            aiQueryInput.prop('disabled', false);\n            clearButton.prop('disabled', false);\n        }\n    }\n\n    // [修改] 主要显示函数 - 更新事件绑定逻辑\n    async function showBeautifiedTokenPopup() {\n        logDebug(\"showBeautifiedTokenPopup: 函数调用开始。\");\n        const loadingContent = `<div style=\"text-align:center; padding: 40px;\"><i class=\"fa-solid fa-spinner fa-spin fa-2x\"></i><p>正在计算 Tokens...</p></div>`;\n        callGenericPopup(loadingContent, POPUP_TYPE.DISPLAY, '', { wide: true, large: true });\n        const loadingDialog = parentWindow.document.querySelector('dialog[open]:not([closing])');\n\n        let currentStats, popupContentContainer, finalDialogContent$; // 重命名stats为currentStats避免混淆\n\n        try {\n            // 1. 计算数据 (初始概览数据)\n            logDebug(\"showBeautifiedTokenPopup: 开始计算统计数据...\");\n            currentStats = await calculateTokenStats(); // 这个stats主要用于概览\n            logDebug(\"showBeautifiedTokenPopup: 统计数据计算完成。\");\n\n            // 2. 构建弹窗内容\n            popupContentContainer = document.createElement('div');\n            popupContentContainer.id = POPUP_CONTENT_ID;\n\n            if (!currentStats || currentStats.error) {\n                popupContentContainer.innerHTML = `<div style=\"padding: 20px; color: red; text-align: center;\">\n                    <h3>错误</h3>\n                    <p>加载统计数据时出错: ${escapeHtml(currentStats?.error || '未知错误')}</p>\n                </div>`;\n            } else {\n                popupContentContainer.innerHTML = createBeautifiedHtml(currentStats); // 使用概览数据创建HTML\n            }\n\n            // 3. 关闭加载弹窗\n            if (loadingDialog && typeof loadingDialog.close === 'function') {\n                try {\n                    loadingDialog.close('loading_finished');\n                } catch(e) {\n                    logDebug(\"关闭加载弹窗时发生错误(可能已被关闭):\", e);\n                }\n            } else {\n                logDebug(\"showBeautifiedTokenPopup: 未找到加载弹窗或无法关闭。\");\n            }\n\n            // 4. 显示最终弹窗\n            finalDialogContent$ = parent$(popupContentContainer);\n            const finalPopupPromise = callGenericPopup(finalDialogContent$, POPUP_TYPE.DISPLAY, '', {\n                wide: true,\n                large: true,\n                allowVerticalScrolling: true,\n                leftAlign: true\n            });\n\n            // 5. 绑定事件 (重要：内部逻辑需要修改以获取完整条目数据)\n            setTimeout(() => {\n                const currentPopupContent = parent$(`dialog[open]:not([closing]) #${POPUP_CONTENT_ID}`);\n                if (currentPopupContent.length === 0) {\n                    logDebug(\"showBeautifiedTokenPopup: 无法找到最终弹窗的内容元素来绑定事件。\");\n                    return;\n                }\n                logDebug(\"showBeautifiedTokenPopup: 开始绑定事件监听器...\");\n\n                // --- 饼图事件监听器保持不变 ---\n                currentPopupContent.find('#token-pie-chart').off('click').on('click', function(e) {\n                    e.preventDefault();\n                    e.stopPropagation(); // Add this line\n\n                    const constant = parseInt(parent$(this).data('constant'));\n                    const selective = parseInt(parent$(this).data('selective'));\n                    const vectorized = parseInt(parent$(this).data('vectorized'));\n                    const constPercent = parseFloat(parent$(this).data('const-percent'));\n                    const selectPercent = parseFloat(parent$(this).data('select-percent'));\n                    const vectPercent = parseFloat(parent$(this).data('vect-percent'));\n                    const total = constant + selective + vectorized;\n\n                    const detailContent = `\n                    <div style=\"padding: 15px;\">\n                        <h3 style=\"text-align: center; margin-bottom: 15px;\">Token 类型详细分布 ()</h3>\n                        <div style=\"display: flex; justify-content: center; margin-bottom: 20px;\">\n                            <div style=\"width: 150px; height: 150px; border-radius: 50%; background: ${parent$(this).css('background')}; border: 1px solid var(--border-color);\"></div>\n                        </div>\n                        <table style=\"width: 100%; border-collapse: collapse;\">\n                            <thead>\n                                <tr>\n                                    <th style=\"text-align: left; padding: 8px; border-bottom: 1px solid var(--border-color);\">类型</th>\n                                    <th style=\"text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);\">Tokens</th>\n                                    <th style=\"text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);\">占比</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                <tr>\n                                    <td style=\"padding: 8px; border-bottom: 1px solid var(--border-color-subtle); ${STYLE_CONSTANT_TEXT}\">蓝灯</td>\n                                    <td style=\"text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color-subtle);\">${constant.toLocaleString()}</td>\n                                    <td style=\"text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color-subtle);\">${constPercent}%</td>\n                                </tr>\n                                <tr>\n                                    <td style=\"padding: 8px; border-bottom: 1px solid var(--border-color-subtle); ${STYLE_SELECTIVE_TEXT}\">绿灯</td>\n                                    <td style=\"text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color-subtle);\">${selective.toLocaleString()}</td>\n                                    <td style=\"text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color-subtle);\">${selectPercent}%</td>\n                                </tr>\n                                <tr>\n                                    <td style=\"padding: 8px; border-bottom: 1px solid var(--border-color-subtle); ${STYLE_VECTORIZED_TEXT}\">向量</td>\n                                    <td style=\"text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color-subtle);\">${vectorized.toLocaleString()}</td>\n                                    <td style=\"text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color-subtle);\">${vectPercent}%</td>\n                                </tr>\n                                <tr>\n                                    <td style=\"padding: 8px; font-weight: bold;\">总计</td>\n                                    <td style=\"text-align: right; padding: 8px; font-weight: bold;\">${total.toLocaleString()}</td>\n                                    <td style=\"text-align: right; padding: 8px; font-weight: bold;\">100%</td>\n                                </tr>\n                            </tbody>\n                        </table>\n                        <div style=\"margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color-subtle); color: var(--text-secondary); font-size: 0.9rem;\">\n                            <div><span style=\"${STYLE_CONSTANT_TEXT}\">蓝灯</span>: 这些Token会始终包含在上下文中</div>\n                            <div><span style=\"${STYLE_SELECTIVE_TEXT}\">绿灯</span>: 仅当其关键词在最近聊天历史中匹配时才会被包含</div>\n                            <div><span style=\"${STYLE_VECTORIZED_TEXT}\">向量</span>: 基于语义相似度激活，可能结合关键词</div>\n                        </div>\n                    </div>`;\n\n                    // Use a custom callback when closing the popup\n                    const detailPopup = callGenericPopup(detailContent, POPUP_TYPE.DISPLAY, 'Token 类型详情', {\n                        wide: false,\n                        callback: () => {\n                            // Prevent scrolling by doing nothing when popup closes\n                        }\n                    });\n                });\n\n                // --- [修改] AI 分析按钮和清空按钮事件 ---\n                const aiButton = currentPopupContent.find('#ai-ask-button');\n                const aiQueryInput = currentPopupContent.find('#ai-query-input');\n                const clearButton = currentPopupContent.find('#ai-clear-chat-button'); // [新增] 获取清空按钮\n                const outputArea = currentPopupContent.find('#ai-output-area'); // [新增] 获取输出区域\n\n                if (aiButton.length && aiQueryInput.length && clearButton.length && outputArea.length && currentStats && !currentStats.error) {\n                     aiButton.off('click').on('click', async () => { // Use .off().on()\n                         const query = aiQueryInput.val();\n                         if (!query || query.trim() === '') {\n                             parentToastr?.warning('请输入您想问 AI 的问题。');\n                             return;\n                         }\n                         // [修改] 检查 generateRaw\n                         if (typeof TavernHelper?.generateRaw !== 'function') {\n                             parentToastr?.error('AI 分析功能不可用 (需要 TavernHelper.generateRaw)。');\n                             return;\n                         }\n                         // 确保传递当前的概览统计数据\n                         await handleAiAnalysis(currentPopupContent, currentStats, query);\n                     });\n\n                     // [新增] 清空对话按钮事件\n                     clearButton.off('click').on('click', () => {\n                         aiAnalysisHistory = []; // 清空全局历史变量\n                         outputArea.html('<div style=\"padding: 10px; color: var(--text-secondary);\">(对话已清空)</div>').addClass('show').css('display', 'block'); // 更新UI\n                         aiQueryInput.val(''); // 清空输入框\n                         parentToastr?.success('AI 分析对话历史已清空');\n                         logDebug(\"AI 分析历史已手动清空\");\n                     });\n\n                } else {\n                     logDebug(\"showBeautifiedTokenPopup: AI 相关元素未找到或数据错误，无法绑定事件。\");\n                }\n\n\n                // --- [修改] 查看条目详情的事件处理 ---\n                const showEntryDetails = async (lorebookName) => {\n                    logDebug(`showEntryDetails: 请求查看 '${lorebookName}' 的详细条目`);\n                    if (!lorebookName) {\n                        parentToastr?.warning(`无法识别世界书名称。`);\n                        return;\n                    }\n\n                    // 设置全局变量\n                    currentViewingLorebook = lorebookName;\n\n                    const lorebookListSection = currentPopupContent.find('#lorebook-list-section');\n                    const entryDetailsSection = currentPopupContent.find('#entry-details-section');\n                    const entryDetailsTitle = entryDetailsSection.find('#entry-details-title');\n                    const entryListContentArea = entryDetailsSection.find('#entry-list-content-area');\n\n                    // 显示加载状态\n                    entryListContentArea.html('<div style=\"text-align:center; padding: 20px;\"><i class=\"fa-solid fa-spinner fa-spin\"></i> 获取条目数据中...</div>');\n                    lorebookListSection.hide();\n                    entryDetailsSection.show();\n                    entryDetailsTitle.text(`'${escapeHtml(lorebookName)}' 条目详情 (加载中...)`);\n                    // 滚动到详情区域顶部\n                    const detailsCard = entryDetailsSection.closest('.card');\n                    if (detailsCard.length) {\n                        detailsCard[0].scrollIntoView({ behavior: 'smooth', block: 'start' });\n                    }\n\n\n                    try {\n                        // !!! 关键：获取完整的条目数据 !!!\n                        const allEntries = await TavernHelper.getLorebookEntries(lorebookName);\n                        logDebug(`showEntryDetails: 获取到 ${allEntries.length} 个条目 for '${lorebookName}'`);\n\n                        // !!! 使用新的渲染函数 !!!\n                        entryListContentArea.html(renderEntryDetailsHtml(allEntries, lorebookName));\n                        entryDetailsTitle.text(`'${escapeHtml(lorebookName)}' 条目详情`);\n\n                        // 添加编辑按钮 (延迟确保DOM更新)\n                        setTimeout(() => {\n                            addAiEditButton(entryDetailsSection, lorebookName);\n                            logDebug(\"添加了AI编辑按钮\");\n                        }, 100);\n\n                    } catch (error) {\n                        console.error(`获取世界书 '${lorebookName}' 条目时出错:`, error);\n                        parentToastr?.error(`获取 '${lorebookName}' 条目失败: ${error.message}`);\n                        entryListContentArea.html(`<div style=\"color: red; padding: 15px;\">获取条目数据失败: ${escapeHtml(error.message)}</div>`);\n                        entryDetailsTitle.text(`'${escapeHtml(lorebookName)}' 条目详情 (错误)`);\n                    }\n                };\n\n                // [修改] 世界书表格行双击事件 (使用新的处理函数)\n                currentPopupContent.off('dblclick', '.lorebook-row').on('dblclick', '.lorebook-row', async function(e) {\n                    e.preventDefault();\n                    logDebug(\"世界书行被双击 (新逻辑)\");\n                    const lorebookName = parent$(this).data('lorebook');\n                    await showEntryDetails(lorebookName); // 调用新的处理函数\n                });\n\n                // --- 返回按钮事件监听器保持不变 ---\n                currentPopupContent.off('click', '#back-to-lorebook-list').on('click', '#back-to-lorebook-list', () => {\n                    const lorebookListSection = currentPopupContent.find('#lorebook-list-section');\n                    const entryDetailsSection = currentPopupContent.find('#entry-details-section');\n                    entryDetailsSection.hide();\n                    lorebookListSection.show();\n                    // 滚动回列表区域顶部\n                    const listCard = lorebookListSection.closest('.card');\n                     if (listCard.length) {\n                         listCard[0].scrollIntoView({ behavior: 'smooth', block: 'start' });\n                     }\n                });\n\n                logDebug(\"showBeautifiedTokenPopup: 事件监听器绑定完成。\");\n            }, 250); // 保持延迟以确保DOM准备好\n\n            await finalPopupPromise;\n            logDebug(\"showBeautifiedTokenPopup: 最终弹窗已关闭或 finalPopupPromise 已解决。\");\n\n        } catch (error) {\n            console.error(\"[TokenCheckerV2H] showBeautifiedTokenPopup 发生意外错误:\", error);\n            if (loadingDialog && typeof loadingDialog.close === 'function') {\n                try {\n                    loadingDialog.close('error_occurred');\n                } catch(e) { /* ignore */ }\n            }\n            callGenericPopup(`<h4 style='color:red;'>错误</h4><p>打开 Token 查看器时发生意外错误: ${escapeHtml(error.message)}</p>`, POPUP_TYPE.DISPLAY);\n        } finally {\n            logDebug(\"showBeautifiedTokenPopup: 函数执行完毕。\");\n        }\n    }\n\n    // 以下函数替换原脚本中的setupTokenButton，但修改调用showBeautifiedTokenPopup\n    function setupTokenButton() {\n        logDebug(\"setupTokenButton: 开始设置 Token 查看器按钮 (美化版 v2.5.5)...\");\n        if (typeof parent$ !== 'function') { console.error(\"[TokenCheckerV2H] Parent jQuery ($) 不可用。\"); return; }\n        try {\n            const pDoc = parentWindow.document;\n            // 更精确地定位目标区域，避免添加到不期望的位置\n            const targetHeader = parent$('#rm_button_selected_ch, #rm_group_generating_info', pDoc).find('h2').first();\n            if (targetHeader.length === 0) {\n                 // 如果找不到目标 h2，尝试添加到角色/群组名称旁边\n                 const fallbackTarget = parent$('#selected_char_name, #group_popup_title', pDoc).first();\n                 if(fallbackTarget.length === 0) {\n                     parent$(`#${BUTTON_ID}`, pDoc).remove(); // 找不到任何合适位置，移除旧按钮\n                     logDebug(\"setupTokenButton: 未找到合适的按钮插入位置。\");\n                     return;\n                 }\n                 let button = parent$(`#${BUTTON_ID}`, pDoc);\n                 if (button.length === 0) {\n                     button = parent$(`<i id=\"${BUTTON_ID}\" class=\"fa-solid fa-chart-pie ${BUTTON_ID}\" title=\"查看 Tokens 详细统计 (v2.5.5 美化版)\" style=\"margin-left: 8px; font-size: 0.9em; cursor: pointer; vertical-align: middle; color: var(--highlight-blue);\"></i>`); // 使用<i>标签更合适\n                     fallbackTarget.after(button);\n                     logDebug('[TokenCheckerV2H] 按钮已添加到回退目标。');\n                 } else {\n                     button.attr('title', '查看 Tokens 详细统计 (v2.5.5 美化版)');\n                 }\n                 button.off('click').on('click', (event) => {\n                     event.stopPropagation();\n                     logDebug(\"Event: Token 查看按钮被点击。\");\n                     showBeautifiedTokenPopup();\n                 });\n\n            } else {\n                // 正常添加到 h2 后面\n                let button = parent$(`#${BUTTON_ID}`, pDoc);\n                 if (button.length === 0) {\n                    // 使用 <i> 标签代替 <div> 更符合图标按钮的语义\n                    button = parent$(`<i id=\"${BUTTON_ID}\" class=\"fa-solid fa-chart-pie ${BUTTON_ID}\" title=\"查看 Tokens 详细统计 (v2.5.5 美化版)\" style=\"margin-left: 5px; font-size: 1em; cursor: pointer; vertical-align: middle; color: var(--highlight-blue);\"></i>`);\n                    targetHeader.after(button);\n                    logDebug('[TokenCheckerV2H] 按钮已添加到 H2 之后。');\n                } else {\n                    // 确保旧按钮（如果是div）被替换为i标签\n                    if (!button.is('i')) {\n                        button.remove();\n                        button = parent$(`<i id=\"${BUTTON_ID}\" class=\"fa-solid fa-chart-pie ${BUTTON_ID}\" title=\"查看 Tokens 详细统计 (v2.5.5 美化版)\" style=\"margin-left: 5px; font-size: 1em; cursor: pointer; vertical-align: middle; color: var(--highlight-blue);\"></i>`);\n                        targetHeader.after(button);\n                    } else {\n                        button.attr('title', '查看 Tokens 详细统计 (v2.5.5 美化版)'); // 更新tooltip\n                    }\n                }\n                 button.off('click').on('click', (event) => {\n                    event.stopPropagation();\n                    logDebug(\"Event: Token 查看按钮被点击。\");\n                    showBeautifiedTokenPopup();\n                });\n            }\n\n            logDebug(\"setupTokenButton: 按钮点击事件已绑定。\");\n        } catch (error) {\n            console.error('[TokenCheckerV2H] setupTokenButton error:', error);\n        }\n    }\n\n    // --- eventMakeLast ---\n    function eventMakeLast(eventSource, eventName, callback) { // 添加 eventName 参数\n        if (eventSource && typeof eventSource.off === 'function' && typeof eventSource.on === 'function') {\n            logDebug(`eventMakeLast: Rebinding event '${eventName}'`);\n            eventSource.off(eventName, callback); // 确保移除特定事件的回调\n            eventSource.on(eventName, callback);\n        } else {\n             console.warn(`eventMakeLast: Invalid eventSource or missing methods for event '${eventName}'`);\n        }\n    }\n\n    // --- Initialization ---\n    async function initializeScript() {\n        logDebug('initializeScript: 初始化 Token 查看器脚本 (v2.5.5 美化版)...');\n        if (typeof parent$ === 'function') {\n            setupTokenButton(); // 初始设置按钮\n            // 监听聊天变化事件，重新设置按钮（以防UI重新渲染导致按钮丢失）\n            if (typeof tavern_events !== 'undefined' && typeof tavern_events.on === 'function' && typeof tavern_events.off === 'function') {\n                 const chatChangeCallback = () => {\n                     logDebug(\"Event: CHAT_CHANGED or GROUP_UPDATED or CHAR_UPDATED 触发，重新运行 setupTokenButton。\");\n                     // 稍微延迟以确保UI更新完成\n                     setTimeout(setupTokenButton, 200);\n                 };\n                 // 监听多个可能导致UI更新的事件\n                 eventMakeLast(tavern_events, 'CHAT_CHANGED', chatChangeCallback);\n                 eventMakeLast(tavern_events, 'GROUP_UPDATED', chatChangeCallback);\n                 eventMakeLast(tavern_events, 'CHAR_UPDATED', chatChangeCallback);\n                 logDebug('initializeScript: 已绑定 CHAT_CHANGED, GROUP_UPDATED, CHAR_UPDATED 事件监听。');\n            } else {\n                console.warn(\"[TokenCheckerV2H] tavern_events 或其 on/off 方法未找到。按钮可能在UI更新后消失。\");\n            }\n        } else {\n            console.error('[TokenCheckerV2H] 无法初始化 UI，缺少父窗口 jQuery。');\n        }\n        logDebug('initializeScript: 初始化完成 (v2.5.5 美化版).');\n    }\n\n    // --- Entry Point ---\n    try {\n        // 延迟初始化以确保SillyTavern和TavernHelper完全加载\n        setTimeout(initializeScript, 1000); // 增加延迟时间\n    } catch(e) {\n        console.error('[TokenCheckerV2H] 初始化顶层错误:', e);\n        parentToastr?.error(`Token 查看器脚本(美化版)初始化失败: ${e.message}`);\n    }\n\n})();",
  "info": "@流流ming",
  "buttons": []
}