# 角色日志系统 (Character Journal System)

一个为SillyTavern设计的扩展，为每个角色创建独立的第一人称日志条目，提升角色扮演质量并大幅节省Token。

## ✨ 核心特性

### 🎭 角色专属记忆
- **第一人称日志**：每个角色以"我"的视角记录经历和感受
- **独立条目管理**：每个角色有自己的世界书条目
- **选择性激活**：只在角色出场时触发，不浪费Token

### 💰 Token高效
- **按需激活**：传统总结全部加载(~5000 tokens)，本系统只加载出场角色(~500-800 tokens)
- **节省率**：单角色场景可节省**80%+** Token
- **智能压缩**：自动精炼过长的日志，保持条目精简

### 🤖 一次请求多角色
- **批量生成**：一次API调用生成所有角色的日志
- **格式化输出**：AI按指定格式分别输出每个角色的内容
- **自动解析**：智能识别并分配到对应角色条目

### 📊 进度追踪
- **楼层记录**：精确记录每个角色的日志更新到第几楼
- **可视化状态**：实时显示各角色的记录进度
- **断点续写**：支持中断后继续更新

## 📦 安装

1. 下载本扩展到SillyTavern的扩展目录：
   ```
   SillyTavern/public/scripts/extensions/third-party/character-journal-system/
   ```

2. 重启SillyTavern或刷新页面

3. 在"扩展"面板中找到"📖 角色日志系统"

## 🚀 快速开始

### 基础配置

1. **启用扩展**
   - 勾选"启用角色日志系统"

2. **选择世界书目标**
   - **角色主世界书**：写入角色卡片绑定的世界书（推荐）
   - **专用世界书**：为每个对话创建独立世界书

3. **角色检测模式**
   - **自动检测**：从对话中自动识别所有角色（推荐）
   - **手动指定**：手动输入要跟踪的角色名（逗号分隔）

### API设置

**选项A：使用SillyTavern默认API**
- 留空所有API字段，自动使用ST的主API设置

**选项B：使用独立API**
- 填写API地址、密钥和模型名
- 适合想用不同API生成日志的情况

### 开始使用

1. 加载一个对话
2. 点击"💾 保存设置"
3. 查看"📊 状态信息"确认角色已检测到
4. 点击"手动更新日志"或等待自动触发
5. 打开世界书查看生成的角色日志条目

## 📖 使用指南

### 日志生成

**触发条件：**
- 对话消息数达到"更新阈值"（默认20条）
- 或手动点击"手动更新日志"按钮

**生成过程：**
1. 系统收集未记录的消息
2. 一次性调用AI为所有角色生成日志
3. 解析AI输出，分配到各角色条目
4. 追加到对应的世界书条目中

**日志格式示例：**
```
Alice的第一人称日志记录：

---

【第1-20楼】
今天我遇到了一个陌生人，他看起来很友善。我们聊了很多关于魔法的话题，
这让我想起了过去的一些事情。虽然表面上保持冷静，但内心其实有些紧张...

【Journal updated through floor 20】

---

【第21-40楼】
和那个人相处得越来越自然了。他提到的理论让我很感兴趣，我决定深入研究一下。
不过我还是对他保持一定警惕，毕竟刚认识不久。

【Journal updated through floor 40】
```

### 自动精炼

当日志条目过长时（默认5000字符），系统可以自动压缩：

**精炼前：**
```
【第1-20楼】今天...
【第21-40楼】后来...
【第41-60楼】然后...
【第61-80楼】接着...
【第81-100楼】最后...
```

**精炼后：**
```
【角色档案】Alice

【性格特征】
冷静理性，但内心敏感。对魔法有深入研究，善于分析问题。

【人际关系】
- Bob: 从陌生到逐渐熟悉，欣赏他的理论见解，但保持警惕
- Carol: 老朋友，信任且依赖

【重要经历】
- 第5楼：首次遇见Bob，讨论魔法理论
- 第45楼：发现重要线索
- 第80楼：与Bob关系突破

【角色成长】
从封闭戒备逐渐变得开放信任（第1-100楼）

---

【最近记忆】
【第81-100楼】最后...
【Journal updated through floor 100】
```

### 世界书条目设置

**关键词模板：**
- `{name}` → 角色名
- 示例：`{name}, {name}的日志` → `Alice, Alice的日志`

**插入位置：**
- 0: 在角色定义之后
- 2: 在聊天历史之前（推荐）
- 4: 在AN顶部

**条目优先级（order）：**
- 数值越大越优先
- 推荐：90（高优先级）

## ⚙️ 高级配置

### 提示词自定义

**日志生成提示词：**
```
你是记忆记录助手。请为每个角色写一段第一人称日志...

输出格式：
===角色:Alice===
[内容]
===角色:Bob===
[内容]
===END===
```

**提示词优化建议：**
1. 明确要求第一人称（我、我的）
2. 指定输出格式标记
3. 说明未出场角色的处理
4. 控制长度（50-300字可调）

### 日志风格

**叙事风格：**
```
今天我遇到了一个有趣的人，我们聊了很多...
```

**情感风格：**
```
见到他时，我的心跳加快了。那种久违的感觉让我既期待又害怕...
```

**分析风格：**
```
综合今天的对话分析，对方的意图可能是...我需要进一步观察...
```

### Token优化对比

**传统总结系统：**
```
所有总结条目都激活
├─ 剧情总结: 2000 tokens
├─ 角色关系: 1500 tokens  
├─ 世界观: 1000 tokens
└─ 其他: 500 tokens
总计: 5000 tokens
```

**角色日志系统：**
```
只激活出场角色
├─ Alice日志: 500 tokens (Alice出场时)
├─ Bob日志: 0 tokens (Bob未出场)
└─ Carol日志: 0 tokens (Carol未出场)
总计: 500 tokens (节省90%)
```

## 🎯 使用场景

### 场景1：多角色群像剧
- **问题**：10个角色，传统总结全部加载浪费Token
- **方案**：每个角色独立日志，只在出场时激活
- **效果**：单场景只加载1-2个角色，节省80%+ Token

### 场景2：长期连载故事
- **问题**：总结越来越长，精炼后失去细节
- **方案**：角色日志分开存储，各自精炼
- **效果**：保留更多角色发展细节

### 场景3：角色一致性维护
- **问题**：AI容易忘记角色的想法和感受
- **方案**：第一人称日志强化角色视角
- **效果**：角色表现更一致、更有深度

## 🔧 故障排除

### Q: 扩展加载失败？
A: 检查文件路径是否正确，确保所有文件都在 `third-party/character-journal-system/` 目录下

### Q: 没有检测到角色？
A: 
1. 确保已加载对话
2. 检查"排除用户角色"选项
3. 尝试手动模式指定角色名

### Q: AI没有按格式输出？
A:
1. 检查提示词是否包含格式标记
2. 尝试调整API模型
3. 增加max_tokens限制

### Q: 世界书条目没有激活？
A:
1. 检查关键词是否正确
2. 确认条目未被禁用
3. 检查世界书的激活设置

### Q: 日志更新失败？
A:
1. 确认角色已绑定世界书（如使用角色主世界书模式）
2. 检查API设置和连接
3. 查看浏览器控制台的错误信息

## 📝 最佳实践

1. **初期使用**
   - 从小阈值开始（10-15条消息）
   - 观察日志质量，调整提示词

2. **日志风格**
   - 叙事风格适合剧情向
   - 情感风格适合恋爱向
   - 分析风格适合推理向

3. **精炼时机**
   - 建议手动触发第一次精炼
   - 检查效果后再启用自动精炼

4. **关键词设置**
   - 至少包含角色名本身
   -
