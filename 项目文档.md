# 角色日志系统 - 完整项目文档

## 📋 目录

1. [项目概述](#项目概述)
2. [核心功能](#核心功能)
3. [系统架构](#系统架构)
4. [详细流程](#详细流程)
5. [关键函数说明](#关键函数说明)
6. [配置项说明](#配置项说明)
7. [数据结构](#数据结构)
8. [常见问题](#常见问题)
9. [维护注意事项](#维护注意事项)

---

## 项目概述

### 🎯 项目目标
为SillyTavern聊天对话中的角色自动生成第一人称日志，并存储到世界书(WorldInfo)中，实现角色记忆的持续追踪。

### 🔑 核心特性
- ✅ AI自动识别对话中的女性角色
- ✅ 生成第一人称日记形式的角色日志
- ✅ 自动读取世界书资料辅助判断
- ✅ 支持批量更新和增量更新
- ✅ 智能过滤（出场次数、性别等由AI判断）
- ✅ 自动精炼压缩长日志
- ✅ 进度追踪和断点续传

### 📦 技术栈
- 语言：JavaScript (ES6+)
- 依赖：SillyTavern扩展API、jQuery
- AI接口：支持自定义OpenAI兼容API或使用ST默认API

---

## 核心功能

### 1. 角色识别
**自动模式（推荐）**
- AI分析对话内容识别重要女性角色
- 自动排除：地点、组织、物品、男性角色
- 排除已跟踪的角色（避免重复）

**手动模式**
- 用户手动输入要跟踪的角色名列表
- 逗号分隔：`炽霞, 秧秧, 今汐`

### 2. 日志生成
**生成规则**
- 第一人称视角（我、我的）
- 每个事件独立成条
- 格式：`• 时间标记 - 事件描述 + 内心感受`
- 长度：50-100字/条

**示例输出**
```
===角色:炽霞===
• 早上巡逻时 - 遇到了杨，昨晚的事让我有些不知所措，但还是强装镇定。
• 巡逻途中 - 听到呼救声，立刻切换到工作模式。
===END===
```

### 3. 智能过滤
**出场次数过滤**
- 设置最小出场次数（默认5次）
- 统计角色名在对话中出现的频率
- 过滤掉一笔带过的龙套角色

**AI自主判断**
- 性别筛选：AI根据世界书资料和对话内容判断性别
- 实体类型：AI判断是角色还是地点/组织
- 出场状态：AI判断本轮是否实际出场

### 4. 进度管理
**增量更新机制**
- 每个角色独立跟踪进度
- 格式：`【已更新至第 250 楼】`
- 下次更新从进度+1楼开始

**批量更新逻辑**
```
已有角色：
- 炽霞(进度50楼) → 更新51-200楼
- 秧秧(进度80楼) → 更新81-200楼

新角色识别：
- 在最大进度之后识别新角色
- 排除已有的12个角色
```

### 5. 自动精炼
**触发条件**
- 日志长度达到阈值（默认5000字符）
- 手动点击"精炼所有日志"按钮

**精炼效果**
- 原始日志 → AI总结 → 精炼摘要
- 提取：性格特征、人际关系、重要经历、成长轨迹
- 覆盖原条目，保留进度封印

---

## 系统架构

### 文件结构
```
character-journal-system/
├── index.js           # 主逻辑文件
├── settings.html      # 设置界面
├── style.css          # 样式文件
├── manifest.json      # 扩展配置
├── README.md          # 用户说明
├── DESIGN.md          # 设计文档
├── 项目文档.md        # 本文档
└── push.bat           # 部署脚本
```

### 核心模块

#### 1. 设置管理模块
- `loadSettings()` - 加载配置
- `saveSettings()` - 保存配置
- `defaultSettings` - 默认配置对象

#### 2. 角色识别模块
- `detectCharactersByAI()` - AI识别角色
- `filterCharacters()` - 出场次数过滤

#### 3. 日志生成模块
- `generateCharacterJournals()` - 生成日志主函数
- `getCharacterWorldInfo()` - 获取角色资料
- `callAI()` - 调用AI接口
- `parseCharacterJournals()` - 解析AI返回结果

#### 4. 更新管理模块
- `executeJournalUpdate()` - 手动更新（单次阈值）
- `executeBatchUpdate()` - 批量更新（指定范围）
- `updateCharacterJournal()` - 更新单个角色条目

#### 5. 精炼模块
- `refineCharacterJournal()` - 精炼单个角色
- `refineAllJournals()` - 批量精炼所有角色

#### 6. 辅助模块
- `getTargetLorebookName()` - 获取目标世界书
- `readJournalProgress()` - 读取角色进度
- `getUnloggedMessages()` - 获取未记录消息
- `extractContentTag()` - 提取content标签内容
- `updateStatus()` - 更新状态显示

---

## 详细流程

### 手动更新流程

```
用户点击"手动更新" 
    ↓
读取所有已有角色及进度
    ↓
为每个角色计算更新范围
├─ 炽霞: 51-70楼 (进度50 + 阈值20)
├─ 秧秧: 81-100楼 (进度80 + 阈值20)
└─ ...
    ↓
在最大进度后识别新角色
└─ 101-120楼: AI识别（排除已有角色）
    ↓
按范围生成日志
├─ 读取消息
├─ 获取世界书资料
├─ 调用AI生成
└─ 解析结果
    ↓
更新世界书条目
├─ 已有条目: 追加新日志
└─ 新角色: 创建新条目
    ↓
检查是否需要精炼
└─ 长度≥阈值 → 自动精炼
    ↓
更新状态显示
```

### 批量更新流程

```
用户输入范围：1-250楼，阈值20
    ↓
读取所有已有角色进度
    ↓
步骤1：为已有角色生成续写任务
├─ 炽霞(50楼) → 51-70, 71-90, 91-110...
├─ 秧秧(80楼) → 81-100, 101-120, 121-140...
└─ 按阈值分批
    ↓
步骤2：生成新角色识别任务
└─ 在最大进度后按阈值分批
    ├─ 101-120楼: AI识别新角色
    ├─ 121-140楼: AI识别新角色
    └─ ...
    ↓
按顺序执行所有任务
├─ 显示进度条
├─ 逐个任务处理
└─ 500ms延迟防止API限流
    ↓
更新完成，显示结果
```

### AI识别流程

```
调用detectCharactersByAI()
    ↓
构建排除列表
├─ 角色卡名字
├─ 用户名（可选）
├─ 手动排除列表
└─ 已存在的角色
    ↓
发送给AI的提示词
├─ 系统规则：只识别女性、重要角色
├─ 排除列表
└─ 对话记录
    ↓
AI分析返回角色名列表
    ↓
解析并过滤
└─ 移除排除列表中的名字
    ↓
返回识别结果
```

### 日志生成流程

```
generateCharacterJournals()
    ↓
确定角色列表
├─ 指定角色（批量更新/手动模式）
└─ AI识别（自动模式）
    ↓
应用出场次数过滤
└─ 统计每个角色出现次数
    ↓
获取角色世界书资料
├─ 遍历聊天世界书
├─ 遍历角色卡世界书
└─ 匹配关键词提取信息
    ↓
构建AI提示
├─ 系统提示词（规则）
├─ 角色列表 + 资料
└─ 对话记录
    ↓
调用AI生成
    ↓
解析AI返回
└─ 正则匹配：===角色:Name===
    ↓
白名单过滤
└─ 只保留允许的角色
    ↓
返回Map<角色名, 日志内容>
```

---

## 关键函数说明

### 1. executeJournalUpdate()
**功能**：执行一次增量更新（按阈值）

**逻辑**：
1. 读取所有角色进度
2. 为每个角色生成更新范围（进度+1 到 进度+阈值）
3. 在最大进度后识别新角色
4. 逐个范围生成日志并更新

**返回**：成功更新的角色数

### 2. executeBatchUpdate(startFloor, endFloor)
**功能**：批量更新指定范围

**参数**：
- `startFloor`: 起始楼层
- `endFloor`: 结束楼层

**逻辑**：
1. 读取角色进度
2. **为已有角色按阈值分批生成续写任务**
3. **为新角色按阈值分批生成识别任务**
4. 按顺序执行所有任务
5. 显示进度条

**关键修复**（2025-11-01）：
- ❌ 旧版：每批次排除已有角色 → 已有角色只生成一次
- ✅ 新版：为已有角色续写 + 识别新角色 → 正确

### 3. generateCharacterJournals(startFloor, endFloor, rangeInfo)
**功能**：为指定范围生成角色日志

**参数**：
- `startFloor`: 起始楼层
- `endFloor`: 结束楼层
- `rangeInfo`: 范围信息对象
  - `characters`: 指定角色列表（null=AI识别）
  - `existingCharacters`: 已存在角色（用于排除）

**返回**：`Map<角色名, 日志内容>`

**流程**：
1. 读取消息
2. 确定角色列表（指定/AI识别）
3. 应用出场次数过滤
4. 获取世界书资料
5. 调用AI生成
6. 解析并过滤结果

### 4. updateCharacterJournal(characterName, journalContent, startFloor, endFloor)
**功能**：更新单个角色的世界书条目

**逻辑**：
1. 加载世界书
2. 查找或创建角色条目
3. 追加新日志内容
4. 添加进度封印
5. 保存世界书
6. 检查是否触发自动精炼

**条目结构**：
- `comment`: `【日志】角色名`
- `content`: `角色名的第一人称日志记录：\n\n---\n\n【第X-Y楼】\n日志内容\n\n【已更新至第 Y 楼】`

### 5. detectCharactersByAI(messages, existingCharacters)
**功能**：AI识别新角色

**参数**：
- `messages`: 消息列表
- `existingCharacters`: 已存在角色列表（用于排除）

**返回**：识别到的角色对象数组

**逻辑**：
1. 构建排除列表（角色卡、用户、已有角色）
2. 发送提示词给AI
3. 解析AI返回的角色名
4. 过滤排除列表中的名字

### 6. getCharacterWorldInfo(characterName)
**功能**：获取角色相关的世界书信息

**查找范围**：
- 当前聊天绑定的世界书
- 角色卡绑定的世界书

**匹配规则**：
- 检查条目的关键词是否包含角色名
- 排除日志和归档条目

### 7. extractContentTag(text)
**功能**：提取消息中的content标签内容

**处理**：
- 优先提取`<content>`标签内容
- 移除其他标签：thinking, tableEdit, chat, details等
- 清理折叠的手机、状态块等

**重要性**：避免将扩展缓存数据当作对话内容

---

## 配置项说明

### 基础设置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | Boolean | false | 是否启用扩展 |
| `target` | String | "character_main" | 目标世界书类型 |
| `dedicatedWorldbook` | String | "" | 专用世界书名称 |
| `detectionMode` | String | "auto" | 角色检测模式（auto/manual） |
| `manualCharacters` | String | "" | 手动指定角色列表（逗号分隔） |
| `excludeNames` | String | "" | 排除的名字列表 |
| `excludeUser` | Boolean | true | 是否排除用户名 |
| `useWorldInfo` | Boolean | true | 是否读取世界书资料 |

### 智能过滤设置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `filterEnabled` | Boolean | true | 是否启用出场次数过滤 |
| `minAppearances` | Number | 5 | 最小出场次数 |

### 更新设置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `autoUpdate` | Boolean | false | **[v1.2新增]** 是否启用自动更新 |
| `updateThreshold` | Number | 20 | 单次更新阈值（楼数） |
| `journalPrompt` | String | (长文本) | AI生成日志的提示词 |

### 精炼设置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `autoRefine` | Boolean | false | 是否自动精炼 |
| `refineThreshold` | Number | 5000 | 精炼阈值（字符数） |
| `keepRecent` | Number | 5 | 保留最近N段（已废弃） |
| `refinePrompt` | String | (长文本) | AI精炼的提示词 |

### 世界书条目设置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `keywordsTemplate` | String | "{name}" | 关键词模板 |
| `insertionPosition` | Number | 2 | 插入位置（0=顶部, 2=底部） |
| `entryOrder` | Number | 90 | 条目排序权重 |
| `depth` | Number | 4 | 扫描深度 |

### API设置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `api.url` | String | "" | API地址（留空使用ST默认） |
| `api.key` | String | "" | API密钥 |
| `api.model` | String | "" | 模型名称 |
| `api.maxTokens` | Number | 2000 | 最大生成长度 |

---

## 数据结构

### 世界书条目结构

```javascript
{
  uid: "1730448000000-炽霞",           // 唯一ID
  key: ["炽霞"],                        // 关键词列表
  keysecondary: [],                     // 次要关键词
  comment: "【日志】炽霞",              // 标识注释
  content: "炽霞的第一人称日志记录：\n\n---\n\n【第1-20楼】\n• 早上...\n\n【已更新至第 20 楼】",
  constant: false,                      // 是否常驻
  selective: true,                      // 是否选择性触发
  order: 90,                            // 排序权重
  position: 2,                          // 插入位置
  disable: false,                       // 是否禁用
  depth: 4,                             // 扫描深度
  probability: 100,                     // 触发概率
  // ... 其他SillyTavern标准字段
}
```

### rangeInfo对象结构

```javascript
{
  characters: ["炽霞", "秧秧"],        // 指定角色列表（null=AI识别）
  startFloor: 51,                       // 起始楼层
  endFloor: 70,                         // 结束楼层
  isExisting: true,                     // 是否为已存在角色
  existingCharacters: ["炽霞", "秧秧"] // 已存在角色（用于排除）
}
```

### 消息对象结构

```javascript
{
  floor: 15,                            // 楼层号
  author: "炽霞",                       // 发言者
  content: "今天天气不错...",          // 消息内容
  isTarget: false                       // 是否为目标角色
}
```

---

## 常见问题

### Q1: 为什么识别不到某个角色？

**可能原因**：
1. **出场次数不足** - 检查"最小出场次数"设置，默认5次
2. **被AI判断为男性** - AI根据世界书资料和对话判断性别
3. **被AI判断为地点/组织** - 如"今州"、"鸣沙阁"等
4. **在排除列表中** - 检查"排除名字列表"设置
5. **已经创建过日志** - 已有角色不会重复识别

**解决方法**：
- 降低最小出场次数
- 切换到手动模式，手动指定角色
- 检查世界书资料是否准确描述角色性别

### Q2: 批量更新时为什么已有角色没有续写？

**答**：这是2025-11-01修复的bug。请确保使用最新版本代码。

**检查方法**：
- 查看`executeBatchUpdate()`函数
- 应该包含"为已有角色生成续写任务"的逻辑
- 应该先处理已有角色，再识别新角色

### Q3: 日志内容为什么包含很多无关标签？

**答**：需要正确提取content标签内容。

**检查**：
- `extractContentTag()`函数是否正常工作
- 是否正确移除thinking、tableEdit等标签

### Q4: AI识别出了地点名怎么办？

**答**：在提示词中已经要求AI排除地点，但可能仍有误判。

**解决**：
1. 手动添加到"排除名字列表"
2. 完善世界书资料，明确标注是地点
3. 改进AI提示词的排除规则

### Q5: 为什么精炼后日志变短了？

**答**：精炼功能设计为压缩长日志，提取核心信息。

**特点**：
- 原始日志可能5000+字
- 精炼后变成结构化摘要（性格、关系、经历、成长）
- 进度封印会保留

**建议**：
- 如需保留原始日志，在精炼前备份世界书
- 可以调高精炼阈值（如10000字符）

### Q6: 手动更新和批量更新有什么区别？

| 特性 | 手动更新 | 批量更新 |
|------|----------|----------|
| 更新范围 | 各角色进度+阈值 | 用户指定范围 |
| 是否分批 | 否（单次阈值） | 是（按阈值分批） |
| 进度条 | 无 | 有 |
| 适用场景 | 日常增量更新 | 补全历史日志 |

---

## 维护注意事项

### ⚠️ 关键逻辑不可破坏

#### 1. 批量更新的双重任务机制
```javascript
// ✅ 必须保持：先为已有角色续写，再识别新角色
// 步骤1：为已有角色生成续写任务
for (const [charName, progress] of characterProgresses.entries()) {
  // 按阈值分批
}

// 步骤2：识别新角色（在最大进度之后）
if (maxProgress < endFloor) {
  // 按阈值分批识别
}
```

**❌ 错误示例**：每批次都排除已有角色去识别

#### 2. 进度封印机制
```javascript
// ✅ 必须保持：每次更新后添加进度封印
const newSeal = `【已更新至第 ${endFloor} 楼】`;
journalEntry.content = contentWithoutSeal + newEntry;
```

**作用**：
- 记录当前角色的更新进度
- 下次更新从进度+1开始
- 避免重复生成

#### 3. content标签提取
```javascript
// ✅ 必须保持：正确提取content标签，移除其他标签
function extractContentTag(text) {
  // 优先提取<content>标签
  // 移除thinking, tableEdit等标签
}
```

**重要性**：避免将扩展缓存误当对话内容

#### 4. 白名单过滤机制
```javascript
// ✅ 必须保持：解析AI返回时进行白名单过滤
const allowedNames = finalCharacters.map(c => c.name);
const journals = parseCharacterJournals(response, allowedNames);
```

**作用**：防止AI返回未授权的角色日志

### 🔧 安全修改指南

#### 可以修改的部分
- ✅ AI提示词内容（journalPrompt, refinePrompt）
- ✅ 默认配置值（updateThreshold, minAppearances等）
- ✅ UI样式和布局
- ✅ 状态显示格式
- ✅ 错误提示文本

#### 需谨慎修改的部分
- ⚠️ 函数参数和返回值结构
- ⚠️ 世界书条目的标识字段（comment、uid命名规则）
- ⚠️ 正则表达式（如PROGRESS_SEAL_REGEX、角色日志解析）
- ⚠️ 事件监听器绑定

#### 绝对不可修改的部分
- ❌ `executeBatchUpdate()`的双重任务逻辑
- ❌ 进度封印的读取和写入机制
- ❌ `extractContentTag()`的标签过滤逻辑
- ❌ 白名单过滤机制

### 📝 版本更新记录

#### v1.2.0 (2025-11-01) - 最新版本
**新功能**：
- ✨ **新增"启用自动更新"开关**：达到阈值后自动触发更新，无需手动点击
- 📊 **优化AI识别显示**：控制台日志改为逗号分隔格式，更易读
- 📏 **缩短世界书资料显示**：从200字缩短到30字，减少干扰
- 🎯 **统一日志格式**：手动更新和批量更新的控制台输出格式一致

**用户体验改进**：
- 🎮 设置界面新增"启用自动更新"复选框（日志设置部分）
- 💾 自动更新状态会保存到配置中
- 🔄 自动更新机制：在消息接收事件后检查并触发

**实现细节**：
```javascript
// 新增配置项
settings.autoUpdate = false  // 默认关闭

// 自动检查机制
eventSource.on(event_types.MESSAGE_RECEIVED, async () => {
    if (settings.enabled && settings.autoUpdate) {
        await checkAndAutoUpdate();
    }
});

// checkAndAutoUpdate() 检查逻辑：
// 1. 检查已有角色是否需要更新（未记录消息数 >= 阈值）
// 2. 检查是否需要识别新角色（新消息数 >= 阈值）
// 3. 触发executeJournalUpdate()自动更新
```

**更新逻辑说明**：
```
所有出场的角色都会更新：
  ├─ 老角色 → 从各自进度继续写，追加到各自的旧条目 ✓
  └─ 新角色 → 创建新条目 ✓

"排除已有角色"的真实含义：
  - 只在AI识别新角色时起作用
  - 避免把老角色误认为新角色，造成重复创建条目
  - 不是说不给老角色更新！
```

#### v1.1.0 (2025-11-01)
**重大修复**：
- 🐛 修复批量更新bug：已有角色现在可以正确续写日志
- 🔧 重构`executeBatchUpdate()`：分离已有角色续写和新角色识别
- ✨ 改进进度显示：批量更新显示详细任务信息

**功能优化**：
- 🗑️ 移除无效的性别过滤设置（由AI自主判断）
- 🗑️ 移除"排除无世界书资料"选项（由AI判断）
- ✅ 保留出场次数过滤（仍然有效）

**代码清理**：
- 清理`filterKeywords`、`filterNoWorldinfo`无用变量
- 简化`filterCharacters()`函数
- 更新settings.html界面

### 🔍 调试技巧

#### 1. 查看控制台日志
```javascript
// 关键日志前缀：[角色日志]
// 查看角色识别：AI识别到的角色
// 查看过滤结果：出场次数过滤
// 查看更新范围：更新范围、任务信息
```

#### 2. 检查世界书条目
- 打开世界书编辑器
- 搜索comment包含"【日志】"的条目
- 查看content末尾的进度封印

#### 3. 验证批量更新逻辑
```javascript
// 在executeBatchUpdate()开头添加：
console.log('[DEBUG] 已有角色进度:', characterProgresses);
console.log('[DEBUG] 更新任务列表:', updateRanges);
```

#### 4. 测试AI识别
```javascript
// 在detectCharactersByAI()查看：
console.log('[DEBUG] 排除列表:', excludeList);
console.log('[DEBUG] AI原始返回:', response);
console.log('[DEBUG] 解析后角色:', detectedNames);
```

### 📚 扩展阅读

#### 相关文件
- `DESIGN.md` - 设计理念和技术细节
- `README.md` - 用户使用指南
- `settings.html` - 设置界面结构

#### SillyTavern API参考
- 世界书API：`loadWorldInfo()`, `saveWorldInfo()`
- 扩展API：`extension_settings`, `getContext()`
- 事件系统：`eventSource`, `event_types`

#### 最佳实践
1. **修改前备份**：修改代码前备份世界书文件
2. **小步测试**：每次修改后用小范围测试
3. **查看日志**：遇到问题先看控制台日志
4. **保持同步**：修改后更新本文档

### 🎯 未来规划

#### 计划中的功能
- [ ] 支持多语言日志生成
- [ ] 日志导出为Markdown
- [ ] 角色关系图谱生成
- [ ] 时间线可视化
- [ ] 日志搜索和筛选

#### 性能优化
- [ ] 缓存世界书数据减少读取
- [ ] 批量更新时合并相同范围的请求
- [ ] 支持中断和恢复批量更新

#### 用户体验
- [ ] 进度条显示预计剩余时间
- [ ] 支持预览日志生成结果再保存
- [ ] 一键备份和恢复日志

---

## 🙏 致谢

感谢所有贡献者和用户的反馈，让这个项目不断改进！

**项目维护者**：[cnfh1746]  
**最后更新**：2025-11-01  
**文档版本**：v1.2.0

---

**注意**：本文档是项目的核心参考资料，任何重大代码修改都应该同步更新本文档。
