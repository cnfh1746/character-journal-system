# ä¿®å¤ä¸–ç•Œä¹¦åˆ›å»ºä¸ç»‘å®šé—®é¢˜ - è¯•é”™è®°å½•

## ç›®æ ‡
1.  åˆ›å»ºä¸–ç•Œä¹¦åï¼Œæ— éœ€åˆ·æ–°ç½‘é¡µå³å¯åœ¨åˆ—è¡¨ä¸­çœ‹åˆ°ã€‚
2.  æ–°åˆ›å»ºçš„ä¸–ç•Œä¹¦èƒ½è‡ªåŠ¨ç»‘å®šåˆ°å½“å‰è§’è‰²çš„â€œèŠå¤©çŸ¥è¯†ä¹¦â€ã€‚

æ“ä½œè§„åˆ™ï¼š
**1æ¯æ¬¡ä¿®å¤åæŠŠå°è¯•å†™å…¥æœ¬æ–‡æ¡£ï¼Œå¹¶è¿è¡Œä¸Šä¼ ä»“åº“bat**
2ç­‰å¾…ç”¨æˆ·éªŒè¯ç»“æœï¼Œè®°å½•ç»“æœ
---

## å°è¯• 1ï¼šåˆ›å»ºååˆ·æ–°UI (å¤±è´¥)

**æ€è·¯:**
åœ¨ `saveWorldInfo` åˆ›å»ºä¸–ç•Œä¹¦æˆåŠŸåï¼Œç«‹å³è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ¥åˆ·æ–°å‰ç«¯çš„ä¸–ç•Œä¹¦åˆ—è¡¨UIã€‚

**å®æ–½ä»£ç :**
åœ¨ `getTargetLorebookName` å‡½æ•°ä¸­ï¼Œæ·»åŠ äº†ä»¥ä¸‹ä»£ç ï¼š

```javascript
// ...
await saveWorldInfo(worldbookName, newBookData, true);
toastr.success(`å·²è‡ªåŠ¨åˆ›å»ºä¸–ç•Œä¹¦: ${worldbookName}`, 'è§’è‰²æ—¥å¿—');

// ã€å°è¯•çš„ä»£ç ã€‘
if (SillyTavern.worldInfo && typeof SillyTavern.worldInfo.refreshWorldInfoList === 'function') {
    await SillyTavern.worldInfo.refreshWorldInfoList();
} else {
    eventSource.emit(event_types.WORLDINFO_UPDATED);
}
// ...
```

**ç»“æœ:**
**æ— æ•ˆ**ã€‚åˆ›å»ºä¸–ç•Œä¹¦åï¼Œå‰ç«¯åˆ—è¡¨å¹¶æœªåˆ·æ–°ã€‚`SillyTavern.worldInfo.refreshWorldInfoList()` å¯èƒ½ä¸å­˜åœ¨æˆ–è°ƒç”¨æ–¹å¼ä¸æ­£ç¡®ï¼Œå¤‡ç”¨çš„ `WORLDINFO_UPDATED` äº‹ä»¶ä¹Ÿæœªè§¦å‘é¢„æœŸçš„UIæ›´æ–°ã€‚

---

## å°è¯• 2ï¼šä½¿ç”¨ `TavernHelper.getOrCreateChatLorebook` (å¤±è´¥)

**æ€è·¯:**
æ ¹æ® `ä¸–ç•Œä¹¦ç»Ÿè®¡ä¸åˆ†æå™¨` è„šæœ¬çš„å®ç°ï¼Œä½¿ç”¨ `TavernHelper.getOrCreateChatLorebook()` å‡½æ•°æ¥ä¸€æ­¥åˆ°ä½åœ°å¤„ç†åˆ›å»ºå’Œç»‘å®šã€‚

**å®æ–½ä»£ç :**
å°† `getTargetLorebookName` å‡½æ•°ä¸­å¤„ç†ä¸–ç•Œä¹¦ä¸å­˜åœ¨çš„ `catch` å—æ•´ä¸ªæ›¿æ¢ï¼š

```javascript
// ...
} catch (error) {
    // ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼Œè®© TavernHelper æ¥å¤„ç†åˆ›å»ºå’Œç»‘å®š
    try {
        // ã€å°è¯•çš„ä»£ç ã€‘
        await TavernHelper.getOrCreateChatLorebook(worldbookName);
        toastr.success(`å·²è‡ªåŠ¨åˆ›å»ºå¹¶ç»‘å®šä¸–ç•Œä¹¦: ${worldbookName}`, 'è§’è‰²æ—¥å¿—');

        if (SillyTavern.worldInfo && typeof SillyTavern.worldInfo.refreshWorldInfoList === 'function') {
            await SillyTavern.worldInfo.refreshWorldInfoList();
        }

    } catch (createError) {
        toastr.error(`åˆ›å»º/ç»‘å®šä¸–ç•Œä¹¦å¤±è´¥: ${createError.message}`, 'è§’è‰²æ—¥å¿—');
    }
}
```

**ç»“æœ:**
**æ— æ•ˆ**ã€‚æ­¤æ–¹æ³•åŒæ ·æœªèƒ½è§£å†³é—®é¢˜ã€‚è™½ç„¶é€»è¾‘ä¸Šçœ‹èµ·æ¥æ›´å¯é ï¼Œä½†å®é™…æ•ˆæœä¸é¢„æœŸä¸ç¬¦ã€‚å¯èƒ½æ˜¯ `TavernHelper` çš„è¿™ä¸ªå‡½æ•°åœ¨æ‰©å±•ä¸­çš„è°ƒç”¨æ—¶æœºæˆ–ä¸Šä¸‹æ–‡ç¯å¢ƒä¸åœ¨ quick-character è„šæœ¬ä¸­ä¸åŒï¼Œå¯¼è‡´å…¶è¡Œä¸ºä¸ä¸€è‡´ã€‚

---

**ç»“è®º:**
ä¸¤ç§åŸºäºå‰ç«¯APIè°ƒç”¨å’Œäº‹ä»¶è§¦å‘çš„æ–¹æ¡ˆéƒ½å¤±è´¥äº†ã€‚é—®é¢˜å¯èƒ½æ¯”é¢„æƒ³çš„æ›´å¤æ‚ï¼Œå¯èƒ½éœ€è¦æ·±å…¥ç ”ç©¶ SillyTavern çš„æ ¸å¿ƒä»£ç ï¼Œæˆ–è€…å¯»æ‰¾å…¶ä»–æ‰©å±•æ˜¯å¦‚ä½•å¤„ç†ç±»ä¼¼é—®é¢˜çš„ã€‚

---

## å°è¯• 3ï¼šå…¨å±€å¯¹è±¡è®¿é—®äº‹ä»¶ç³»ç»Ÿ (å¤±è´¥)

**é—®é¢˜:**
CHARACTER_SELECTED äº‹ä»¶ç›‘å¬å™¨æ— æ³•æ³¨å†Œï¼Œæ§åˆ¶å°æ˜¾ç¤ºï¼š
```
[è§’è‰²æ—¥å¿—] äº‹ä»¶ç³»ç»Ÿæœªå°±ç»ªï¼Œ2ç§’åé‡è¯•...
```
æ— é™å¾ªç¯é‡è¯•ï¼Œå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚

**è¯Šæ–­:**
é€šè¿‡æ§åˆ¶å°è¯Šæ–­å‘ç°ï¼š
- `eventSource: undefined`
- `event_types: undefined`
- åŸå› æ˜¯ `window.eventSource` å’Œ `window.SillyTavern?.eventSource` éƒ½ä¸º undefined

**å®æ–½ä»£ç :**
```javascript
const getEventSource = () => window.eventSource || window.SillyTavern?.eventSource;
const getEventTypes = () => window.event_types || window.SillyTavern?.event_types;

const initEventListeners = () => {
    const eventSource = getEventSource();
    const event_types = getEventTypes();
    
    if (!eventSource || !event_types) {
        console.warn('[è§’è‰²æ—¥å¿—] äº‹ä»¶ç³»ç»Ÿæœªå°±ç»ªï¼Œ2ç§’åé‡è¯•...');
        setTimeout(initEventListeners, 2000);
        return;
    }
    
    // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨...
};
```

**ç»“æœ:**
**å¤±è´¥**ã€‚äº‹ä»¶ç³»ç»Ÿæ°¸è¿œæ— æ³•åˆå§‹åŒ–ï¼Œå¯¼è‡´æ— é™é‡è¯•å¾ªç¯ã€‚è¯´æ˜å…¨å±€å¯¹è±¡è®¿é—®è·¯å¾„ä¸æ­£ç¡®ï¼Œæˆ–è€…äº‹ä»¶ç³»ç»Ÿçš„åŠ è½½æ—¶æœºæ¯”æ‰©å±•æ›´æ™šã€‚

**åˆ†æ:**
- SillyTavern çš„äº‹ä»¶ç³»ç»Ÿå¯èƒ½ä¸æ˜¯é€šè¿‡å…¨å±€å¯¹è±¡æš´éœ²çš„
- æ‰©å±•çš„ import è¯­å¥å¯èƒ½æ‰æ˜¯æ­£ç¡®çš„è®¿é—®æ–¹å¼
- éœ€è¦æ£€æŸ¥å…¶ä»–æ‰©å±•æ˜¯å¦‚ä½•æˆåŠŸè®¿é—®äº‹ä»¶ç³»ç»Ÿçš„

---

## å°è¯• 4ï¼šä½¿ç”¨ ES6 import ç›´æ¥å¯¼å…¥äº‹ä»¶ç³»ç»Ÿ âŒ (å¤±è´¥)

**æ€è·¯:**
æ”¾å¼ƒé€šè¿‡å…¨å±€å¯¹è±¡è®¿é—®ï¼Œæ”¹ç”¨æ ‡å‡†çš„ ES6 import è¯­å¥ç›´æ¥ä» `script.js` å¯¼å…¥ `eventSource` å’Œ `event_types`ã€‚

**å®æ–½ä»£ç :**

1. **ä¿®æ”¹ import è¯­å¥ï¼ˆç¬¬2è¡Œï¼‰:**
```javascript
// ä¿®æ”¹å‰
import { saveSettingsDebounced } from "../../../../script.js";

// ä¿®æ”¹å
import { saveSettingsDebounced, eventSource, event_types } from "../../../../script.js";
```

2. **åˆ é™¤å…¨å±€å¯¹è±¡è·å–å‡½æ•°ï¼ˆç¬¬11-12è¡Œï¼‰:**
```javascript
// åˆ é™¤è¿™äº›è¡Œ
const getEventSource = () => window.eventSource || window.SillyTavern?.eventSource;
const getEventTypes = () => window.event_types || window.SillyTavern?.event_types;
```

3. **ç®€åŒ–äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–é€»è¾‘:**
```javascript
// ä¿®æ”¹å‰ï¼ˆæœ‰å»¶è¿Ÿé‡è¯•é€»è¾‘ï¼‰
const initEventListeners = () => {
    const eventSource = getEventSource();
    const event_types = getEventTypes();
    
    if (!eventSource || !event_types) {
        console.warn('[è§’è‰²æ—¥å¿—] äº‹ä»¶ç³»ç»Ÿæœªå°±ç»ªï¼Œ2ç§’åé‡è¯•...');
        setTimeout(initEventListeners, 2000);
        return;
    }
    
    console.log('[è§’è‰²æ—¥å¿—] âœ“ äº‹ä»¶ç³»ç»Ÿå·²å°±ç»ªï¼Œæ³¨å†Œäº‹ä»¶ç›‘å¬å™¨');
    
    eventSource.on(event_types.MESSAGE_RECEIVED, async () => { ... });
    eventSource.on(event_types.USER_MESSAGE_RENDERED, () => { ... });
    eventSource.on(event_types.CHARACTER_SELECTED, async () => { ... });
};

initEventListeners();

// ä¿®æ”¹åï¼ˆç›´æ¥æ³¨å†Œï¼Œå»é™¤å»¶è¿Ÿé€»è¾‘ï¼‰
console.log('[è§’è‰²æ—¥å¿—] âœ“ å¼€å§‹æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨');

eventSource.on(event_types.MESSAGE_RECEIVED, async () => { ... });
eventSource.on(event_types.USER_MESSAGE_RENDERED, () => { ... });
eventSource.on(event_types.CHARACTER_SELECTED, async () => { ... });
```

**ç»“æœ:**
âŒ **å¤±è´¥**ã€‚æ§åˆ¶å°æ—¥å¿—è¢«æ¸…ç©ºï¼Œæ— æ³•çœ‹åˆ°å…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•ã€‚

**å¾…éªŒè¯:**
- import æ˜¯å¦æˆåŠŸå¯¼å…¥äº† eventSource å’Œ event_types
- äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦çœŸæ­£æ³¨å†ŒæˆåŠŸ
- CHARACTER_SELECTED äº‹ä»¶æ˜¯å¦èƒ½å¤Ÿè§¦å‘

**ä¸‹ä¸€æ­¥è°ƒè¯•æ–¹å‘:**
1. æ·»åŠ è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤ import çš„å€¼
2. æ£€æŸ¥å…¶ä»–æˆåŠŸçš„æ‰©å±•æ˜¯å¦‚ä½•æ³¨å†Œäº‹ä»¶çš„
3. å¯èƒ½éœ€è¦æŸ¥çœ‹ SillyTavern æºç ä¸­ eventSource çš„å®é™…æš´éœ²æ–¹å¼

---

## å°è¯• 5ï¼šä¿®å¤äº‹ä»¶åç§° - ä½¿ç”¨ CHAT_CHANGED æ›¿ä»£ CHARACTER_SELECTED âœ… (æˆåŠŸ)

**é—®é¢˜:**
åˆ‡æ¢è§’è‰²æ—¶æ— æ³•è§¦å‘è‡ªåŠ¨ä¸–ç•Œä¹¦åŠ è½½åŠŸèƒ½ã€‚

**è¯Šæ–­:**
é€šè¿‡è°ƒè¯•å‘ç°ï¼š
- `eventSource` å’Œ `event_types` å¯¼å…¥æˆåŠŸ
- å‰ä¸¤ä¸ªäº‹ä»¶ (`MESSAGE_RECEIVED`, `USER_MESSAGE_RENDERED`) èƒ½æ­£å¸¸å·¥ä½œ
- ä½† `CHARACTER_SELECTED` äº‹ä»¶ä»æœªè§¦å‘

**æ ¹æœ¬åŸå› :**
âŒ SillyTavern ä¸­**ä¸å­˜åœ¨** `CHARACTER_SELECTED` äº‹ä»¶ï¼
âœ… æ­£ç¡®çš„äº‹ä»¶åº”è¯¥æ˜¯ `CHAT_CHANGED` (`'chat_id_changed'`)

**å®æ–½ä»£ç :**
```javascript
// âŒ é”™è¯¯çš„ä»£ç ï¼ˆä¿®æ”¹å‰ï¼‰
eventSource.on(event_types.CHARACTER_SELECTED, async () => {
    // è§’è‰²åˆ‡æ¢å¤„ç†...
});

// âœ… æ­£ç¡®çš„ä»£ç ï¼ˆä¿®æ”¹åï¼‰
eventSource.on(event_types.CHAT_CHANGED, async () => {
    try {
        console.log('[è§’è‰²æ—¥å¿—] ========== ğŸ”” CHAT_CHANGED äº‹ä»¶è§¦å‘ ==========');
        
        const settings = extension_settings[extensionName];
        if (settings.enabled && settings.target === "character_main") {
            const context = getContext();
            const newCharName = context.name2 || "è§’è‰²";
            
            // è‡ªåŠ¨åˆ‡æ¢ä¸–ç•Œä¹¦
            const newWorldbook = await getTargetLorebookName();
            await updateStatus();
            toastr.info(`å·²åŠ è½½ ${newWorldbook}`, 'è§’è‰²æ—¥å¿—');
        }
    } catch (error) {
        console.error('[è§’è‰²æ—¥å¿—] âŒ CHAT_CHANGED äº‹ä»¶å¤„ç†å¤±è´¥:', error);
    }
});
```

**CHAT_CHANGED äº‹ä»¶è§¦å‘æ—¶æœº:**
- åˆ‡æ¢è§’è‰²æ—¶
- åˆ‡æ¢èŠå¤©æ—¶
- èŠå¤©IDå‘ç”Ÿå˜åŒ–æ—¶

**ç»“æœ:**
âœ… **æˆåŠŸï¼** åˆ‡æ¢è§’è‰²æ—¶ï¼š
1. âœ“ æ­£ç¡®è§¦å‘ `CHAT_CHANGED` äº‹ä»¶
2. âœ“ è‡ªåŠ¨åˆ‡æ¢åˆ°å¯¹åº”è§’è‰²çš„ä¸–ç•Œä¹¦ï¼ˆ`character_main` æ¨¡å¼ä¸‹ï¼‰
3. âœ“ ä½¿ç”¨ TavernHelper è‡ªåŠ¨åˆ›å»ºå¹¶ç»‘å®šä¸–ç•Œä¹¦ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
4. âœ“ æ˜¾ç¤º toast æç¤ºï¼š`å·²åŠ è½½ [è§’è‰²å]æ—¥å¿—`
5. âœ“ æ›´æ–°çŠ¶æ€é¢æ¿æ˜¾ç¤º

**ç»éªŒæ•™è®­:**
- äº‹ä»¶åç§°å¿…é¡»ç²¾ç¡®åŒ¹é… SillyTavern çš„å®é™…äº‹ä»¶
- å¯ä»¥é€šè¿‡æŸ¥çœ‹ `event_types` å¯¹è±¡æˆ–å…¶ä»–æ‰©å±•çš„æºç æ¥ç¡®è®¤æ­£ç¡®çš„äº‹ä»¶å
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—å’Œé”™è¯¯å¤„ç†æœ‰åŠ©äºå¿«é€Ÿå®šä½é—®é¢˜

---
